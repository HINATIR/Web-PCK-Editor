<!--
    Web PCK Editor
  
    PCK„Éï„Ç°„Ç§„É´ÔºàMinecraftÁî®„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºâ„Çí„Éñ„É©„Ç¶„Ç∂„ÅßÁ∑®ÈõÜ„Åô„Çã„ÉÑ„Éº„É´„Åß„Åô„ÄÇ
  
    ‰ΩøÁî®ÊäÄË°ì:
    - HTML5
    - CSS3
    - JavaScript (ES6+)
  
    „É©„Ç§„Çª„É≥„Çπ:
    „Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅØGNU General Public License v3.0 (GPL-3.0)„ÅÆ‰∏ã„ÅßÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
    Ë©≥Á¥∞„ÅØLICENSE„Éï„Ç°„Ç§„É´„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  
    GitHub: https://github.com/HINATIR/Web-PCK-Editor
  
    ÂèÇËÄÉË≥áÊñô„ÉªÂºïÁî®:
    - PCK-Studio (GPL-3.0 License)
        https://github.com/LCERD/PCK-Studio
        PCK„Éï„Ç°„Ç§„É´„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å®Ê©üËÉΩ‰ªïÊßò„ÅÆÂèÇËÄÉË≥áÊñô
        Authors: PhoenixARC, MayN-L, NessieHax, EternalModz
  
    - OMI-Filetype-Library (GPL-3.0 License)
        https://github.com/LCERD/OMI-Filetype-Library
        PCK„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Éº„Çπ‰ªïÊßòÂèÇËÄÉË≥áÊñô
        Authors: NessieHax, PhoenixARC, MayN-L, Bagietas
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEB PCK Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0, 122, 204, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* „É°„Éã„É•„Éº„Éê„Éº */
        .menu-bar {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0;
            height: 35px;
            user-select: none;
            position: relative;
        }

        .mobile-menu-toggle {
            display: none;
            padding: 8px 12px;
            cursor: pointer;
            color: #cccccc;
            font-size: 18px;
            background: none;
            border: none;
            transition: background 0.2s;
        }

        .mobile-menu-toggle:hover {
            background: #3e3e42;
        }

        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: #cccccc;
            font-size: 13px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #3e3e42;
        }

        .menu-item:active {
            background: #007acc;
            color: white;
        }

        /* „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Éê„Éº */
        .info-bar {
            background: #007acc;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            display: none;
            justify-content: space-between;
            align-items: center;
            min-height: 32px;
        }

        .info-bar.active {
            display: flex;
        }

        .info-left, .info-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 11px;
        }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºà„Ç¢„Çª„ÉÉ„Éà‰∏ÄË¶ßÔºâ */
        .sidebar {
            width: 320px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 12px;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .asset-count {
            color: #858585;
            font-size: 11px;
            font-weight: normal;
        }

        .asset-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-action-button {
            padding: 12px 10px;
            border-top: 1px solid #3e3e42;
            background: #252526;
        }

        .sidebar-action-button .btn-action {
            width: 100%;
        }

        .asset-item {
            padding: 10px 15px;
            border-bottom: 1px solid #2d2d30;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }

        .asset-item:hover {
            background: #2a2d2e;
        }

        .asset-item:active {
            background: #333638;
        }

        .asset-item.selected {
            background: #094771;
        }

        .asset-item.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #007acc;
        }

        .asset-item.crash-warning {
            background: rgba(211, 47, 47, 0.15);
            border-left: 3px solid #d32f2f;
        }

        .asset-item.crash-warning:hover {
            background: rgba(211, 47, 47, 0.25);
        }

        .asset-item.crash-warning.selected {
            background: rgba(211, 47, 47, 0.35);
        }

        .asset-delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #d32f2f;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .asset-item:hover .asset-delete-btn {
            opacity: 1;
        }

        .asset-delete-btn:hover {
            background: #ff5252;
        }

        .asset-filename {
            color: #d4d4d4;
            font-size: 13px;
            margin-bottom: 4px;
            word-break: break-all;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .asset-directory {
            color: #7d7d7d;
            font-size: 12px;
            opacity: 0.7;
            font-weight: 400;
        }

        .asset-file {
            color: #d4d4d4;
            font-weight: 500;
        }

        .asset-type-icon {
            font-size: 16px;
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        .asset-info {
            font-size: 11px;
            color: #858585;
        }

        /* „ÉÑ„É™„Éº„Éì„É•„Éº - „Éï„Ç©„É´„ÉÄ */
        .asset-folder {
            margin-bottom: 0;
        }

        .asset-folder-toggle {
            width: 100%;
            padding: 8px 12px;
            background: #252526;
            border: none;
            border-bottom: 1px solid #3e3e42;
            color: #d4d4d4;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
            font-family: inherit;
        }

        .asset-folder-toggle:hover {
            background: #2d2d30;
        }

        .asset-folder-toggle:active {
            background: #007acc;
        }

        .asset-folder-content {
            display: none;
            margin-left: 12px;
            border-left: 1px solid #3e3e42;
            padding-left: 0;
        }

        .asset-folder.expanded .asset-folder-content {
            display: block;
        }

        /* „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº */
        .context-menu {
            position: fixed;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            min-width: 180px;
        }

        .context-menu.hidden {
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            color: #d4d4d4;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .context-menu-item:hover {
            background: #2d2d30;
        }

        .context-menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background: transparent;
        }

        .context-menu-divider {
            height: 1px;
            background: #3e3e42;
            margin: 4px 0;
        }

        /* Âè≥ÂÅ¥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢Ôºà‰∏äÂçäÂàÜÔºâ */
        .preview-area {
            flex: 1;
            background: #1e1e1e;
            border-bottom: 1px solid #3e3e42;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 12px 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 12px;
            color: #cccccc;
        }

        .preview-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        /* Ë©≥Á¥∞„Ç®„É™„Ç¢Ôºà‰∏ãÂçäÂàÜÔºâ */
        .details-area {
            height: 300px;
            background: #252526;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .details-header {
            padding: 12px 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 12px;
            color: #cccccc;
        }

        .details-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        .detail-row {
            display: flex;
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid #2d2d30;
        }

        .detail-label {
            min-width: 110px;
            color: #569cd6;
            font-weight: 600;
        }

        .detail-value {
            color: #d4d4d4;
            word-break: break-all;
            flex: 1;
        }

        .properties-section {
            margin-top: 15px;
        }

        .properties-title {
            color: #569cd6;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .property-item {
            padding: 8px 0;
            font-size: 12px;
            border-bottom: 1px solid #2d2d30;
            display: grid;
            grid-template-columns: 150px 1fr 30px;
            gap: 10px;
            align-items: center;
        }

        .property-delete-btn {
            background: #d32f2f;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
            padding: 0;
        }

        .property-delete-btn:hover {
            background: #ff5252;
        }

        .property-key {
            color: #9cdcfe;
            font-weight: 600;
        }

        .property-key-input {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #9cdcfe;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 600;
            width: 100%;
        }

        .property-key-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .property-value-input {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #ce9178;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 12px;
            width: 100%;
        }

        .property-value-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .asset-action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2d2d30;
        }

        .btn-asset-action {
            padding: 6px 14px;
            background: #0e639c;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .btn-asset-action:hover {
            background: #1177bb;
        }

        .btn-asset-action:active {
            background: #0d5a8f;
            transform: scale(0.98);
        }

        .btn-asset-action:disabled {
            background: #3e3e42;
            color: #858585;
            cursor: not-allowed;
        }

        .loc-entry-item {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .loc-entry-key {
            color: #4ec9b0;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .loc-entry-values {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .loc-value-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loc-lang-label {
            min-width: 50px;
            color: #858585;
            font-size: 11px;
        }

        .loc-value-input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 12px;
        }

        .loc-value-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .loc-table-editable {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .loc-table-editable th {
            background: #2d2d30;
            color: #cccccc;
            padding: 8px;
            text-align: left;
            border: 1px solid #3e3e42;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .loc-table-editable td {
            padding: 4px;
            border: 1px solid #3e3e42;
        }

        .loc-table-editable .key-cell {
            color: #4ec9b0;
            font-weight: 600;
            background: #252526;
            padding: 8px;
        }

        .loc-table-editable .value-cell {
            background: #1e1e1e;
        }

        .loc-table-editable input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: #cccccc;
            padding: 6px 8px;
            font-size: 12px;
        }

        .loc-table-editable input:focus {
            outline: none;
            border-color: #007acc;
            background: #2d2d30;
        }

        .loc-editor-container {
            display: flex;
            height: 100%;
            gap: 10px;
        }

        .loc-keys-panel {
            width: 300px;
            background: #252526;
            border: 1px solid #3e3e42;
            overflow-y: auto;
        }

        .loc-key-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #2d2d30;
            color: #4ec9b0;
            font-size: 12px;
            font-family: 'Consolas', monospace;
        }

        .loc-key-item:hover {
            background: #2d2d30;
        }

        .loc-key-item.selected {
            background: #094771;
            border-left: 3px solid #007acc;
        }

        .loc-detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .loc-bulk-replace {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .loc-bulk-replace-title {
            color: #cccccc;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loc-bulk-replace-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .loc-bulk-replace-input input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 12px;
        }

        .loc-bulk-replace-input input:focus {
            outline: none;
            border-color: #007acc;
        }

        .loc-bulk-replace-btn {
            background: #0e639c;
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .loc-bulk-replace-btn:hover {
            background: #1177bb;
        }

        .loc-values-container {
            flex: 1;
            overflow-y: auto;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 12px;
        }

        .loc-value-edit-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .loc-lang-label-edit {
            color: #858585;
            font-size: 12px;
            font-weight: 600;
        }

        .loc-value-edit-input {
            background: #252526;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 12px;
            width: 100%;
        }

        .loc-value-edit-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .loc-no-selection {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #858585;
            font-size: 13px;
        }

        /* „Éó„É¨„Éì„É•„ÉºÁî®„Çπ„Çø„Ç§„É´ */
        .preview-hex {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #d4d4d4;
            background: #1e1e1e;
            white-space: pre;
        }

        .empty-message {
            text-align: center;
            color: #6a737d;
            padding: 60px 20px;
            font-size: 14px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* „Ç¶„Çß„É´„Ç´„É†ÁîªÈù¢ */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #858585;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 25px;
            opacity: 0.4;
        }

        .welcome-text {
            font-size: 18px;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .welcome-hint {
            font-size: 13px;
            opacity: 0.7;
        }

        /* „Éï„Ç°„Ç§„É´ÂÖ•Âäõ */
        #fileInput {
            display: none;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border: 3px solid #1e1e1e;
            border-radius: 7px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* LOC„ÉÜ„Éº„Éñ„É´„Çπ„Çø„Ç§„É´ */
        .loc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: #1a1a1a;
        }

        .loc-table thead tr {
            background: #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .loc-table th {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #fff;
        }

        .loc-table td {
            border: 1px solid #444;
            padding: 8px;
            background: #1a1a1a;
        }

        .loc-table .key-cell {
            font-family: 'Consolas', monospace;
            color: #4FC3F7;
        }

        .loc-table .value-cell {
            color: #ddd;
        }

        .loc-stats {
            margin-top: 12px;
            color: #888;
            font-size: 11px;
        }

        /* „Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .details-header {
            padding: 12px 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 12px;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-action:hover {
            background: #005fa3;
        }

        .btn-action:active {
            background: #004578;
        }

        /* „É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Çπ„Çø„Ç§„É´ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-dialog {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            max-width: 500px;
            width: 90vw;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 12px 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }

        .modal-close:hover {
            color: #ccc;
        }

        .modal-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 12px 15px;
            background: #2d2d30;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-primary {
            padding: 8px 16px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-primary:hover {
            background: #005fa3;
        }

        .btn-primary:active {
            background: #004578;
            transform: scale(0.98);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: #3e3e42;
            color: #cccccc;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .btn-secondary:active {
            background: #555555;
            transform: scale(0.98);
        }

        .skin-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #1a1a1a;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skin-item:hover {
            background: #2a2a2a;
            border-color: #007acc;
        }

        .skin-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skin-item.disabled:hover {
            background: #1a1a1a;
            border-color: #3e3e42;
        }

        .skin-item-name {
            color: #d4d4d4;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .skin-item-dir {
            color: #7d7d7d;
            font-size: 12px;
            opacity: 0.7;
            font-weight: 400;
        }

        .skin-item-file {
            color: #d4d4d4;
            font-weight: 600;
        }

        .skin-item-info {
            color: #888;
            font-size: 11px;
        }

        /* „Éï„Ç©„Éº„É†ÂÖ•Âäõ„Çπ„Çø„Ç§„É´ */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            color: #d4d4d4;
            font-size: 12px;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            font-size: 12px;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #007acc;
            background: #252526;
        }

        .form-select {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            font-size: 12px;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .form-select:focus {
            outline: none;
            border-color: #007acc;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            margin: 10px 0;
            image-rendering: pixelated;
        }

        .save-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .save-dialog {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 25px;
            min-width: 450px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .save-dialog-title {
            font-size: 16px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 20px;
        }

        .save-dialog-field {
            margin-bottom: 18px;
        }

        .save-dialog-label {
            display: block;
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .save-dialog-input {
            width: 100%;
            padding: 8px 10px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #cccccc;
            border-radius: 3px;
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
        }

        .save-dialog-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .save-dialog-radio-group {
            display: flex;
            gap: 20px;
        }

        .save-dialog-radio {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .save-dialog-radio input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .save-dialog-radio label {
            color: #cccccc;
            cursor: pointer;
            font-size: 13px;
        }

        .save-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .save-dialog-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .save-dialog-btn-primary {
            background: #007acc;
            color: white;
        }

        .save-dialog-btn-primary:hover {
            background: #005a9e;
        }

        .save-dialog-btn-secondary {
            background: #3e3e42;
            color: #cccccc;
        }

        .save-dialog-btn-secondary:hover {
            background: #505050;
        }

        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .menu-bar {
                height: 44px;
            }

            .menu-item {
                padding: 8px 10px;
                font-size: 12px;
            }

            .info-bar {
                flex-wrap: wrap;
                padding: 6px 10px;
                font-size: 11px;
            }

            .info-left, .info-right {
                gap: 8px;
            }

            .info-item {
                gap: 3px;
            }

            .sidebar {
                position: absolute;
                left: -320px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s ease;
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.5);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .sidebar-header {
                padding: 10px 12px;
                font-size: 11px;
            }

            .asset-count {
                font-size: 10px;
            }

            .asset-item {
                padding: 12px 12px;
            }

            .asset-filename {
                font-size: 14px;
            }

            .asset-type-icon {
                font-size: 18px;
            }

            .asset-delete-btn {
                opacity: 1;
                right: 8px;
            }

            .content-area {
                width: 100%;
            }

            .preview-area {
                min-height: 40vh;
            }

            .details-area {
                height: auto;
                min-height: 200px;
                max-height: 40vh;
            }

            .preview-header, .details-header {
                padding: 10px 12px;
                font-size: 11px;
            }

            .preview-content, .details-content {
                padding: 12px;
            }

            .btn-action {
                padding: 8px 14px;
                font-size: 12px;
                touch-action: manipulation;
            }

            .btn-asset-action {
                padding: 8px 16px;
                font-size: 13px;
                touch-action: manipulation;
            }

            .modal-dialog {
                width: 95vw;
                max-width: none;
            }

            .save-dialog {
                min-width: auto;
                width: 90vw;
                padding: 20px;
            }

            .save-dialog-radio-group {
                flex-direction: column;
                gap: 12px;
            }

            .property-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .property-delete-btn {
                justify-self: end;
            }

            .loc-editor-container {
                flex-direction: column;
            }

            .loc-keys-panel {
                width: 100%;
                max-height: 200px;
            }

            .form-input, .form-select {
                font-size: 16px;
            }

            .save-dialog-input {
                font-size: 16px;
            }

            .property-key-input, .property-value-input {
                font-size: 16px;
            }

            .loc-value-input, .loc-value-edit-input {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .menu-item:not(:first-child) {
                padding: 8px 6px;
                font-size: 11px;
            }

            .info-bar {
                font-size: 10px;
            }

            .sidebar {
                width: 280px;
                left: -280px;
            }

            .asset-filename {
                font-size: 13px;
            }

            .detail-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .detail-label {
                min-width: auto;
                margin-bottom: 4px;
            }
        }
    </style>
</head>
<body>
    <!-- „É°„Éã„É•„Éº„Éê„Éº -->
    <div class="menu-bar">
        <button class="mobile-menu-toggle" onclick="viewer.toggleSidebar()" aria-label="„É°„Éã„É•„Éº">‚ò∞</button>
        <div class="menu-item" onclick="viewer.showNewPackageDialog()">üìÑ Êñ∞Ë¶è‰ΩúÊàê</div>
        <div class="menu-item" onclick="viewer.openFile()">üìÅ „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</div>
        <div class="menu-item" onclick="viewer.saveFile()" id="menuSave" style="opacity: 0.5; pointer-events: none;">üíæ ‰øùÂ≠ò</div>
        <div class="menu-item" onclick="viewer.closeFile()" id="menuClose" style="opacity: 0.5; pointer-events: none;">‚úï Èñâ„Åò„Çã</div>
    </div>

    <!-- Êñ∞Ë¶è‰ΩúÊàê„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="save-dialog-overlay" id="newPackageDialogOverlay">
        <div class="save-dialog">
            <div class="save-dialog-title">üìÑ Êñ∞„Åó„ÅÑPCK„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàê</div>
            
            <div class="save-dialog-field">
                <label class="save-dialog-label">„Éë„ÉÉ„ÇØÂêç</label>
                <input type="text" class="save-dialog-input" id="newPackageName" placeholder="my_pack">
            </div>
            
            <div class="save-dialog-field">
                <label class="save-dialog-label">PACKID</label>
                <input type="text" class="save-dialog-input" id="newPackagePACKID" placeholder="0-16777215 (0xFFFFFF)ÊúÄÂ§ßÂÄ§" value="0">
            </div>
            
            <div class="save-dialog-field">
                <label class="save-dialog-label">„Ç®„É≥„Éá„Ç£„Ç¢„É≥</label>
                <div class="save-dialog-radio-group">
                    <div class="save-dialog-radio">
                        <input type="radio" name="newPackageEndian" value="little" id="newPackageEndianLittle" checked>
                        <label for="newPackageEndianLittle">Little Endian (PS4/PSVita/Switch)</label>
                    </div>
                    <div class="save-dialog-radio">
                        <input type="radio" name="newPackageEndian" value="big" id="newPackageEndianBig">
                        <label for="newPackageEndianBig">Big Endian (PS3/Xbox360/WiiU)</label>
                    </div>
                </div>
            </div>
            
            <div class="save-dialog-buttons">
                <button class="save-dialog-btn save-dialog-btn-secondary" onclick="viewer.closeNewPackageDialog()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="save-dialog-btn save-dialog-btn-primary" onclick="viewer.createNewPackage()">‰ΩúÊàê</button>
            </div>
        </div>
    </div>

    <!-- ‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="save-dialog-overlay" id="saveDialogOverlay">
        <div class="save-dialog">
            <div class="save-dialog-title">üíæ PCK„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò</div>
            
            <div class="save-dialog-field">
                <label class="save-dialog-label">„Ç®„É≥„Éá„Ç£„Ç¢„É≥</label>
                <div class="save-dialog-radio-group">
                    <div class="save-dialog-radio">
                        <input type="radio" name="endian" value="little" id="endianLittle" checked>
                        <label for="endianLittle">Little Endian (PS4/PSVita/Switch)</label>
                    </div>
                    <div class="save-dialog-radio">
                        <input type="radio" name="endian" value="big" id="endianBig">
                        <label for="endianBig">Big Endian (PS3/Xbox360/WiiU)</label>
                    </div>
                </div>
            </div>
            
            <div class="save-dialog-buttons">
                <button class="save-dialog-btn save-dialog-btn-secondary" onclick="viewer.closeSaveDialog()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="save-dialog-btn save-dialog-btn-primary" onclick="viewer.confirmSave()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Éê„Éº -->
    <div class="info-bar" id="infoBar">
        <div class="info-left">
            <div class="info-item">
                <span>üì¶</span>
                <span id="infoFilename">-</span>
            </div>
            <div class="info-item">
                <span>üìä</span>
                <span id="infoEndian" class="info-badge">-</span>
            </div>
            <div class="info-item">
                <span>üéÆ</span>
                <span id="infoPlatform">-</span>
            </div>
        </div>
        <div class="info-right">
            <div class="info-item">
                <span>üìÅ <span id="infoAssetCount">0</span> „Ç¢„Çª„ÉÉ„Éà</span>
            </div>
            <div class="info-item">
                <span>üíæ <span id="infoTotalSize">0 B</span></span>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä -->
    <div class="main-container">
        <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºà„Ç¢„Çª„ÉÉ„Éà‰∏ÄË¶ßÔºâ -->
        <div class="sidebar">
            <div class="sidebar-header">
                „Ç¢„Çª„ÉÉ„Éà‰∏ÄË¶ß
                <span class="asset-count" id="assetCountLabel">0 „Ç¢„Çª„ÉÉ„Éà</span>
            </div>
            <div class="asset-list" id="assetList">
                <div class="welcome-screen">
                    <div class="welcome-icon">üì¶</div>
                    <div class="welcome-text">PCK „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</div>
                    <div class="welcome-hint">„Äå„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</div>
                </div>
            </div>
            <div class="sidebar-action-button">
                <button class="btn-action" onclick="viewer.openSkinAddDialog()">‚ûï ADD SKIN</button>
            </div>
        </div>

        <!-- „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº -->
        <div class="context-menu hidden" id="contextMenu"></div>

        <!-- Âè≥ÂÅ¥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
        <div class="content-area">
            <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢Ôºà‰∏äÂçäÂàÜÔºâ -->
            <div class="preview-area">
                <div class="preview-header" id="previewHeader">„Éó„É¨„Éì„É•„Éº</div>
                <div class="preview-content" id="previewContent">
                    <div class="empty-message">
                        <div class="empty-icon">üëà</div>
                        Â∑¶ÂÅ¥„Åã„Çâ„Ç¢„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
            </div>

            <!-- Ë©≥Á¥∞„Ç®„É™„Ç¢Ôºà‰∏ãÂçäÂàÜÔºâ -->
            <div class="details-area">
                <div class="details-header">
                    <span>„Ç¢„Çª„ÉÉ„ÉàË©≥Á¥∞</span>
                </div>
                <div class="details-content" id="detailsContent">
                    <div class="empty-message">
                        <div class="empty-icon">‚ÑπÔ∏è</div>
                        „Ç¢„Çª„ÉÉ„ÉàÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Çπ„Ç≠„É≥ÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal-overlay" id="skinModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span id="skinModalTitle">„Çπ„Ç≠„É≥„ÇíÈÅ∏Êäû</span>
                <button class="modal-close" onclick="viewer.closeSkinModal()">&times;</button>
            </div>
            <div class="modal-content" id="skinModalContent"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="viewer.closeSkinModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <!-- „Çπ„Ç≠„É≥„Ç§„É≥„Éù„Éº„Éà„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <span>Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É≥„ÇíËøΩÂä†</span>
                <button class="modal-close" onclick="viewer.closeImportModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">„Çπ„Ç≠„É≥ÁîªÂÉè„Éï„Ç°„Ç§„É´</label>
                    <input type="file" id="skinFileInput" class="form-input" accept=".png" onchange="viewer.handleSkinFileSelect(this.files[0])" />
                </div>
                <div id="skinPreviewArea" style="display: none;">
                    <img id="skinPreview" class="preview-image" />
                </div>
                <div class="form-group">
                    <label class="form-label">„Çπ„Ç≠„É≥ÂêçÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="skinNameInput" class="form-input" placeholder="‰æã: Custom Skin" />
                </div>
                <div class="form-group">
                    <label class="form-label">„ÉÜ„Éº„ÉûÂêçÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" id="skinThemeInput" class="form-input" placeholder="‰æã: Adventure" />
                </div>
                <div class="form-group">
                    <label class="form-label">„Çπ„Ç≠„É≥ID</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="skinIdInput" class="form-input" placeholder="100000-99999998" maxlength="8" style="flex: 1;" />
                        <button class="btn-action" onclick="viewer.generateSkinId()" style="white-space: nowrap;">üîÑ Auto-Gen</button>
                    </div>
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">
                        Ëá™ÂãïÁîüÊàêÔºàAuto-GenÔºâ„Çí‰Ωø„ÅÜ„Å®„ÄÅÊó¢Â≠ò„Çπ„Ç≠„É≥„Å®ÈáçË§á„Åó„Å™„ÅÑID„ÅåÂâ≤„ÇäÂΩì„Å¶„Çâ„Çå„Åæ„Åô
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">„É¢„Éá„É´„Çø„Ç§„Éó</label>
                    <select id="skinModelInput" class="form-select">
                        <option value="steve">Steve (0x00040000)</option>
                        <option value="alex">Alex (0x00080000)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">„Éû„É≥„ÉàÁîªÂÉè„Éï„Ç°„Ç§„É´Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ</label>
                    <input type="file" id="capeFileInput" class="form-input" accept=".png" onchange="viewer.handleCapeFileSelect(this.files[0])" />
                </div>
                <div id="capePreviewArea" style="display: none;">
                    <img id="capePreview" class="preview-image" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="viewer.closeImportModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-primary" onclick="viewer.addSkinToPackage()">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".pck" />
    <input type="file" id="pngReplaceInput" accept=".png" style="display: none;" />

    <script>
        // =====================================================
        // PCK „Éë„Éº„Çµ„Éº
        // =====================================================

        class PckParser {
            constructor(arrayBuffer) {
                this.buffer = arrayBuffer;
                this.view = new DataView(arrayBuffer);
                this.offset = 0;
                this.assets = [];
                this.endianness = 'big';
                this.logs = [];
                this.platformInfo = '';
                this.isLittleEndian = false;
            }

            log(message, type = 'info') {
                console.log(message);
                this.logs.push({ message, type });
            }

            canRead(bytes) {
                return this.offset + bytes <= this.buffer.byteLength;
            }

            readByte() {
                if (!this.canRead(1)) throw new Error(`RangeError: offset=${this.offset}`);
                return this.view.getUint8(this.offset++);
            }

            readUint32(littleEndian = false) {
                if (!this.canRead(4)) throw new Error(`RangeError: offset=${this.offset}`);
                const value = this.view.getUint32(this.offset, littleEndian);
                this.offset += 4;
                return value;
            }

            readUint16(littleEndian = false) {
                if (!this.canRead(2)) throw new Error(`RangeError: offset=${this.offset}`);
                const value = this.view.getUint16(this.offset, littleEndian);
                this.offset += 2;
                return value;
            }

            readData(length) {
                if (!this.canRead(length)) throw new Error(`RangeError: offset=${this.offset}, length=${length}`);
                const data = new Uint8Array(this.buffer, this.offset, length);
                this.offset += length;
                return data;
            }

            parse() {
                try {
                    this.log('========================================');
                    this.log('PCK „Éï„Ç°„Ç§„É´Ëß£ÊûêÈñãÂßãÔºàOMI PckFileReader Ê∫ñÊã†Ôºâ');
                    this.log('========================================');
                    this.log(`„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: ${this.buffer.byteLength} „Éê„Ç§„Éà\n`);

                    if (this.buffer.byteLength < 12) {
                        throw new Error('„Éï„Ç°„Ç§„É´„ÅåÂ∞è„Åï„Åô„Åé„Åæ„Åô');
                    }

                    // „Ç®„É≥„Éá„Ç£„Ç¢„É≥„Éç„ÇπÊ§úÂá∫
                    const pckTypeBE = this.view.getUint32(0, false);
                    const pckTypeLE = this.view.getUint32(0, true);
                    
                    let littleEndian = false;
                    let pckType;
                    
                    this.log('üîç „Ç®„É≥„Éá„Ç£„Ç¢„É≥„Éç„ÇπÊ§úÂá∫:');
                    this.log(`   Big Endian „Å®„Åó„Å¶Ë™≠„ÇÄ„Å®: ${pckTypeBE}`);
                    this.log(`   Little Endian „Å®„Åó„Å¶Ë™≠„ÇÄ„Å®: ${pckTypeLE}`);
                    
                    if (pckTypeBE > 0x00F00000) {
                        // Â§ß„Åç„Åô„Åé„Çã„ÅÆ„ÅßLittle Endian
                        littleEndian = true;
                        pckType = pckTypeLE;
                        this.log(`‚úÖ Little Endian Á¢∫ÂÆö`);
                    } else {
                        // Ê≠£Â∏∏„Å™ÂÄ§„Å™„ÅÆ„ÅßBig Endian
                        littleEndian = false;
                        pckType = pckTypeBE;
                        this.log(`‚úÖ Big Endian Á¢∫ÂÆö`);
                    }

                    this.log(`üì¶ PCK Type: ${pckType}`);
                    
                    // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÊÉÖÂ†±„ÇíË°®Á§∫
                    const platformInfo = this.getPlatformInfo(littleEndian);
                    this.log(`üéÆ „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†: ${platformInfo}`);
                    this.log(`üìä „Ç®„É≥„Éá„Ç£„Ç¢„É≥: ${littleEndian ? 'Little Endian (LE)' : 'Big Endian (BE)'}\n`);

                    if (pckType < 3 || pckType > 20) {
                        throw new Error(`PCK Type „ÅåÁÑ°Âäπ: ${pckType} (ÊúâÂäπÁØÑÂõ≤: 3-20)`);
                    }
                    
                    // „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÊÉÖÂ†±„Çí‰øùÂ≠ò
                    this.platformInfo = platformInfo;
                    this.isLittleEndian = littleEndian;
                    this.pckType = pckType;

                    // 1. „Éó„É≠„Éë„ÉÜ„Ç£„É´„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉÜ„Éº„Éñ„É´Ë™≠„ÅøËæº„Åø
                    this.offset = 4;
                    const { propertyList, hasVersionStr } = this.readLookUpTable(littleEndian);
                    this.log(`üìã LUTË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${propertyList.length}ÂÄã„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£`);
                    if (hasVersionStr) {
                        this.log(`   ‚ö†Ô∏è XML_VERSION_STRING Ê§úÂá∫`);
                    }

                    // 2. „Ç¢„Çª„ÉÉ„Éà„Ç®„É≥„Éà„É™Ë™≠„ÅøËæº„Åø
                    this.log(`\nüìÇ „Ç¢„Çª„ÉÉ„Éà„Ç®„É≥„Éà„É™Ë™≠„ÅøËæº„ÅøÈñãÂßã (offset=0x${this.offset.toString(16)})`);
                    const assetEntries = this.readAssetEntries(littleEndian);
                    this.log(`‚úÖ ${assetEntries.length}ÂÄã„ÅÆ„Ç¢„Çª„ÉÉ„Éà„Ç®„É≥„Éà„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü\n`);

                    // 3. „Ç¢„Çª„ÉÉ„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑË™≠„ÅøËæº„Åø
                    this.log(`üíæ „Ç¢„Çª„ÉÉ„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑË™≠„ÅøËæº„ÅøÈñãÂßã (offset=0x${this.offset.toString(16)})`);
                    this.readAssetContents(assetEntries, propertyList, littleEndian);
                    
                    this.log(`\n‚úÖ Ëß£ÊûêÂÆå‰∫Ü: ${this.assets.length}ÂÄã„ÅÆ„Ç¢„Çª„ÉÉ„Éà`);
                    return this.assets;
                } catch (error) {
                    this.log(`üí• PCK „Éë„Éº„ÇπÂ§±Êïó: ${error.message}`, 'error');
                    console.error(error);
                    return [];
                }
            }

            readLookUpTable(littleEndian) {
                const count = this.readUint32(littleEndian);
                this.log(`   LUT „Ç®„É≥„Éà„É™Êï∞: ${count}`);
                
                const propertyList = [];
                for (let i = 0; i < count; i++) {
                    const index = this.readUint32(littleEndian);
                    const value = this.readStringWithPadding(littleEndian);
                    propertyList[index] = value;
                }
                
                // XML_VERSION_STRING „ÉÅ„Çß„ÉÉ„ÇØ
                const hasVersionStr = propertyList.includes('XMLVERSION');
                if (hasVersionStr) {
                    const xmlVersion = this.readUint32(littleEndian);
                    this.log(`   XML Version: ${xmlVersion}`);
                }
                
                return { propertyList, hasVersionStr };
            }

            readAssetEntries(littleEndian) {
                const assetCount = this.readUint32(littleEndian);
                this.log(`   „Ç¢„Çª„ÉÉ„ÉàÊï∞: ${assetCount}`);
                
                if (assetCount <= 0 || assetCount > 100000) {
                    throw new Error(`„Ç¢„Çª„ÉÉ„ÉàÊï∞„ÅåÁï∞Â∏∏: ${assetCount}`);
                }
                
                const entries = [];
                for (let i = 0; i < assetCount; i++) {
                    const assetSize = this.readUint32(littleEndian);
                    const assetType = this.readUint32(littleEndian);
                    const filename = this.readStringWithPadding(littleEndian).replace(/\\/g, '/');
                    
                    entries.push({ assetSize, assetType, filename });
                }
                
                return entries;
            }

            readAssetContents(assetEntries, propertyList, littleEndian) {
                for (let i = 0; i < assetEntries.length; i++) {
                    const entry = assetEntries[i];
                    
                    try {
                        // „Éó„É≠„Éë„ÉÜ„Ç£Ë™≠„ÅøËæº„Åø
                        const propertyCount = this.readUint32(littleEndian);
                        const properties = [];
                        
                        for (let j = 0; j < propertyCount; j++) {
                            const keyIndex = this.readUint32(littleEndian);
                            const key = propertyList[keyIndex];
                            const value = this.readStringWithPadding(littleEndian);
                            properties.push({ key, value });
                        }
                        
                        // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                        const dataOffset = this.offset;
                        const data = this.readData(entry.assetSize);
                        
                        this.assets.push({
                            filename: entry.filename,
                            typeCode: entry.assetType,
                            dataSize: entry.assetSize,
                            dataOffset,
                            properties,
                            data
                        });
                        
                        this.log(`   ‚úÖ [${i}] "${entry.filename}" Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü`);
                    } catch (error) {
                        this.log(`   ‚ùå [${i}] "${entry.filename}" Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${error.message}`, 'error');
                    }
                }
            }

            readStringWithPadding(littleEndian) {
                const len = this.readUint32(littleEndian);
                if (len < 0 || len > 100000) {
                    throw new Error(`ÊñáÂ≠óÂàóÈï∑„ÅåÁï∞Â∏∏: ${len}`);
                }
                
                const str = this.readStringUTF16(len, littleEndian);
                this.readUint32(littleEndian); // padding
                return str;
            }

            getPlatformInfo(isLittleEndian) {
                if (isLittleEndian) {
                    return 'PS4 / PSVita / Switch';
                } else {
                    return 'PS3 / WiiU';
                }
            }

            readStringUTF16(lengthInChars, littleEndian = false) {
                const byteLength = lengthInChars * 2;
                if (!this.canRead(byteLength)) {
                    throw new Error(`UTF-16 ÊñáÂ≠óÂàóË™≠„ÅøËæº„ÅøÂ§±Êïó`);
                }

                let decoded = '';
                for (let i = 0; i < lengthInChars; i++) {
                    const byte1 = this.view.getUint8(this.offset + i * 2);
                    const byte2 = this.view.getUint8(this.offset + i * 2 + 1);
                    const charCode = littleEndian ? (byte2 << 8) | byte1 : (byte1 << 8) | byte2;
                    if (charCode === 0) break;
                    decoded += String.fromCharCode(charCode);
                }

                this.offset += byteLength;
                return decoded;
            }
        }

        // =====================================================
        // LOC „Éï„Ç°„Ç§„É´„Éë„Éº„Çµ„Éº
        // =====================================================

        class LOCParser {
            constructor(arrayBuffer) {
                this.buffer = arrayBuffer;
                this.view = new DataView(arrayBuffer);
                this.offset = 0;
            }

            readUint32(littleEndian = false) {
                const value = this.view.getUint32(this.offset, littleEndian);
                this.offset += 4;
                return value;
            }

            readUint16(littleEndian = false) {
                const value = this.view.getUint16(this.offset, littleEndian);
                this.offset += 2;
                return value;
            }

            readByte() {
                return this.view.getUint8(this.offset++);
            }

            readBoolean() {
                return this.readByte() !== 0;
            }

            readBytes(length) {
                const bytes = new Uint8Array(this.buffer, this.offset, length);
                this.offset += length;
                return bytes;
            }

            readStringUTF8() {
                const length = this.readUint16(false);
                if (length === 0) return '';
                
                const bytes = new Uint8Array(this.buffer, this.offset, length);
                this.offset += length;
                
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(bytes);
            }

            parse() {
                try {
                    const loc_type = this.readUint32(false);
                    const language_count = this.readUint32(false);
                    const lookUpKey = loc_type === 2;

                    let hasUids = false;
                    let keys = null;

                    if (lookUpKey) {
                        hasUids = this.readBoolean();
                        this.offset--;
                        keys = this.readKeys();
                    }

                    const languages = [];
                    const bufferSizes = [];
                    for (let i = 0; i < language_count; i++) {
                        const language = this.readStringUTF8();
                        const bufferSize = this.readUint32(false);
                        languages.push(language);
                        bufferSizes.push(bufferSize);
                    }

                    const locData = {};
                    const versions = {};
                    const hasUidsInEntry = {};
                    for (let i = 0; i < language_count; i++) {
                        const language = languages[i];
                        const bufferSize = bufferSizes[i];
                        const entryData = this.readBytes(bufferSize);
                        
                        const entryParser = new LOCParser(entryData.buffer.slice(entryData.byteOffset, entryData.byteOffset + entryData.byteLength));
                        
                        const version = entryParser.readUint32(false);
                        versions[language] = version;
                        
                        if (version > 0) {
                            const hasUidsValue = entryParser.readBoolean();
                            hasUidsInEntry[language] = hasUidsValue;
                        }

                        const entryLanguage = entryParser.readStringUTF8();
                        const count = entryParser.readUint32(false);

                        locData[language] = {};
                        for (let j = 0; j < count; j++) {
                            const key = lookUpKey ? keys[j] : entryParser.readStringUTF8();
                            const value = entryParser.readStringUTF8();
                            locData[language][key] = value;
                        }
                    }

                    return { languages, locData, keys, versions, hasUidsInEntry, hasUids, loc_type };

                } catch (error) {
                    console.error('LOC Parse Error:', error);
                    return null;
                }
            }

            readKeys() {
                const useUniqueIds = this.readBoolean();
                const keyCount = this.readUint32(false);
                const keys = [];

                for (let i = 0; i < keyCount; i++) {
                    if (useUniqueIds) {
                        const id = this.readUint32(false);
                        keys.push(id.toString(16).toUpperCase().padStart(8, '0'));
                    } else {
                        keys.push(this.readStringUTF8());
                    }
                }

                return keys;
            }
        }

        // =====================================================
        // UI „Ç≥„É≥„Éà„É≠„Éº„É©
        // =====================================================

        class PckViewer {
            constructor() {
                this.parser = null;
                this.assets = [];
                this.selectedAsset = null;
                this.currentFilename = '';
                this.currentLocData = null;
                this.selectedLocKey = null;
                this.currentTargetFolderNode = null;
                this.currentTargetFolderPath = '';
                this.currentPckFolder = null;
                this.setupEventListeners();
            }

            // PCK„Ç¢„Çª„ÉÉ„Éà„ÇíÊ≠£„Åó„Åè„Ç®„É≥„Ç≥„Éº„Éâ
            encodePck(assets, pckType = 3, littleEndian = false) {
                console.log('=== PCK Encode Start ===');
                console.log('Assets count:', assets.length);
                console.log('PCK Type:', pckType);
                console.log('LittleEndian:', littleEndian);
                
                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÈô§Â§ñ
                const assetsToEncode = assets.filter(asset => !asset._isPlaceholder);
                console.log('Assets to encode (excluding placeholders):', assetsToEncode.length);
                
                const chunks = [];
                
                // 1. PCK Type (4„Éê„Ç§„Éà)
                const typeBuffer = new ArrayBuffer(4);
                new DataView(typeBuffer).setUint32(0, pckType, littleEndian);
                chunks.push(new Uint8Array(typeBuffer));
                console.log('PCK Type written:', pckType);
                
                // 2. „Éó„É≠„Éë„ÉÜ„Ç£„É´„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉÜ„Éº„Éñ„É´„ÇíÊßãÁØâ
                const propertyMap = new Map();
                let propertyIndex = 0;
                
                assetsToEncode.forEach(asset => {
                    if (asset.properties) {
                        asset.properties.forEach(prop => {
                            if (prop.key && !propertyMap.has(prop.key)) {
                                propertyMap.set(prop.key, propertyIndex++);
                            }
                        });
                    }
                });
                
                console.log('Property map size:', propertyMap.size);
                
                // LUT count
                const lutCountBuffer = new ArrayBuffer(4);
                new DataView(lutCountBuffer).setUint32(0, propertyMap.size, littleEndian);
                chunks.push(new Uint8Array(lutCountBuffer));
                
                // LUT entries
                propertyMap.forEach((index, key) => {
                    const indexBuffer = new ArrayBuffer(4);
                    new DataView(indexBuffer).setUint32(0, index, littleEndian);
                    chunks.push(new Uint8Array(indexBuffer));
                    chunks.push(this.encodeStringWithPadding(key, littleEndian));
                });
                
                // 3. „Ç¢„Çª„ÉÉ„Éà„Ç®„É≥„Éà„É™
                const assetCountBuffer = new ArrayBuffer(4);
                new DataView(assetCountBuffer).setUint32(0, assetsToEncode.length, littleEndian);
                chunks.push(new Uint8Array(assetCountBuffer));
                console.log('Asset count written:', assetsToEncode.length);
                
                assetsToEncode.forEach((asset, idx) => {
                    console.log(`Asset ${idx}: ${asset.filename}, type: ${asset.typeCode}, size: ${asset.dataSize}`);
                    
                    // assetSize
                    const sizeBuffer = new ArrayBuffer(4);
                    new DataView(sizeBuffer).setUint32(0, asset.dataSize, littleEndian);
                    chunks.push(new Uint8Array(sizeBuffer));
                    
                    // assetType
                    const typeBuffer = new ArrayBuffer(4);
                    new DataView(typeBuffer).setUint32(0, asset.typeCode, littleEndian);
                    chunks.push(new Uint8Array(typeBuffer));
                    
                    // filename
                    chunks.push(this.encodeStringWithPadding(asset.filename, littleEndian));
                });
                
                // 4. „Ç¢„Çª„ÉÉ„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑ
                assetsToEncode.forEach((asset, idx) => {
                    // propertyCount
                    const propCount = asset.properties ? asset.properties.length : 0;
                    const propCountBuffer = new ArrayBuffer(4);
                    new DataView(propCountBuffer).setUint32(0, propCount, littleEndian);
                    chunks.push(new Uint8Array(propCountBuffer));
                    
                    console.log(`Asset ${idx} properties count:`, propCount);
                    
                    // properties
                    if (asset.properties) {
                        asset.properties.forEach(prop => {
                            const keyIndex = propertyMap.get(prop.key);
                            const keyIndexBuffer = new ArrayBuffer(4);
                            new DataView(keyIndexBuffer).setUint32(0, keyIndex, littleEndian);
                            chunks.push(new Uint8Array(keyIndexBuffer));
                            chunks.push(this.encodeStringWithPadding(prop.value, littleEndian));
                        });
                    }
                    
                    // data
                    chunks.push(asset.data);
                });
                
                // ÂÖ®„Å¶ÁµêÂêà
                const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
                const result = new Uint8Array(totalLength);
                let offset = 0;
                chunks.forEach(chunk => {
                    result.set(chunk, offset);
                    offset += chunk.length;
                });
                
                console.log('Total encoded size:', totalLength);
                console.log('=== PCK Encode End ===');
                
                return result.buffer;
            }
            
            encodeStringWithPadding(str, littleEndian = false) {
                const chunks = [];
                
                // length (ÊñáÂ≠óÊï∞)
                const lengthBuffer = new ArrayBuffer(4);
                new DataView(lengthBuffer).setUint32(0, str.length, littleEndian);
                chunks.push(new Uint8Array(lengthBuffer));
                
                // UTF-16 string
                const strBuffer = new ArrayBuffer(str.length * 2);
                const strView = new DataView(strBuffer);
                for (let i = 0; i < str.length; i++) {
                    strView.setUint16(i * 2, str.charCodeAt(i), littleEndian);
                }
                chunks.push(new Uint8Array(strBuffer));
                
                // padding (Â∏∏„Å´0)
                const paddingBuffer = new ArrayBuffer(4);
                new DataView(paddingBuffer).setUint32(0, 0, littleEndian);
                chunks.push(new Uint8Array(paddingBuffer));
                
                const totalLength = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
                const result = new Uint8Array(totalLength);
                let offset = 0;
                chunks.forEach(chunk => {
                    result.set(chunk, offset);
                    offset += chunk.length;
                });
                
                return result;
            }

            setupEventListeners() {
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
                    console.log('File input listener registered');
                } else {
                    console.error('fileInput element not found in setupEventListeners');
                }

                // „É¢„Éê„Ç§„É´„Åß„Çµ„Ç§„Éâ„Éê„ÉºÂ§ñ„Çí„Çø„ÉÉ„Éó„Åó„Åü„ÇâÈñâ„Åò„Çã
                document.addEventListener('click', (e) => {
                    const sidebar = document.querySelector('.sidebar');
                    const toggle = document.querySelector('.mobile-menu-toggle');
                    if (sidebar && sidebar.classList.contains('mobile-open')) {
                        if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                            this.closeSidebar();
                        }
                    }
                });
            }

            toggleSidebar() {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('mobile-open');
                }
            }

            closeSidebar() {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('mobile-open');
                }
            }

            getPlatformInfo(isLittleEndian) {
                if (isLittleEndian) {
                    return 'PS4 / PSVita / Switch';
                } else {
                    return 'PS3 / WiiU';
                }
            }

            showNewPackageDialog() {
                document.getElementById('newPackageName').value = '';
                document.getElementById('newPackagePACKID').value = '0';
                document.getElementById('newPackageEndianLittle').checked = true;
                document.getElementById('newPackageDialogOverlay').style.display = 'flex';
            }

            closeNewPackageDialog() {
                document.getElementById('newPackageDialogOverlay').style.display = 'none';
            }

            createNewPackage() {
                const packageName = document.getElementById('newPackageName').value.trim();
                if (!packageName) {
                    alert('„Éë„ÉÉ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const packIdStr = document.getElementById('newPackagePACKID').value.trim();
                if (!packIdStr) {
                    alert('PACKID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const packId = parseInt(packIdStr, 10);
                const MAX_PACK_ID = 0xffffff; // 16777215
                const MIN_PACK_ID = 0;

                if (isNaN(packId)) {
                    alert('PACKID„ÅØÊï¥Êï∞„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                    return;
                }

                if (packId < MIN_PACK_ID || packId > MAX_PACK_ID) {
                    alert(`PACKID„ÅØ${MIN_PACK_ID}ÔΩû${MAX_PACK_ID}Ôºà0x${MAX_PACK_ID.toString(16).toUpperCase()}Ôºâ„ÅÆÁØÑÂõ≤ÂÜÖ„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô`);
                    return;
                }

                const isLittleEndian = document.getElementById('newPackageEndianLittle').checked;

                // Êñ∞„Åó„ÅÑPCKParser„Çí‰ΩúÊàêÔºàÁ©∫„ÅÆ„Éê„ÉÉ„Éï„Ç°Ôºâ
                const emptyBuffer = new ArrayBuffer(1024 * 1024);
                this.parser = new PckParser(emptyBuffer);
                this.parser.isLittleEndian = isLittleEndian;
                this.parser.pckType = 8; // PCK Type 8 (‰∏ÄËà¨ÁöÑ„Å™ÂΩ¢Âºè)
                this.parser.platformInfo = this.getPlatformInfo(isLittleEndian);
                this.assets = [];

                // „Éï„Ç°„Ç§„É´Âêç„ÄÇ0"„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÇíËøΩÂä†ÔºàPACKID„Éó„É≠„Éë„ÉÜ„Ç£‰ªò„ÅçÔºâ
                const packIdAsset = {
                    filename: '0',
                    typeCode: 4,
                    dataSize: 0,
                    dataOffset: 0,
                    properties: [
                        { key: 'PACKID', value: packId.toString() }
                    ],
                    data: new Uint8Array(0)
                };
                this.assets.push(packIdAsset);

                // LOC„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàêÔºà„Åô„Åπ„Å¶„ÅÆ„Çµ„Éù„Éº„ÉàË®ÄË™û„ÇíËøΩÂä†Ôºâ
                const languages = [
                    'cs-CS', 'cs-CZ', 'da-DA', 'da-DK', 'de-DE', 'el-EL', 'el-GR', 
                    'en-EN', 'en-GB', 'es-ES', 'es-MX', 'fi-FI', 'fr-FR', 'it-IT', 
                    'ja-JP', 'ko-KR', 'la-LAS', 'nb-NO', 'nl-NL', 'no-NO', 'pl-PL', 
                    'pt-BR', 'pt-PT', 'ru-RU', 'sk-SK', 'sv-SE', 'sv-SV', 'tr-TR', 
                    'zh-CHT', 'zh-CN', 'zh-HANS', 'zh-HANT'
                ];
                const locData = {};
                languages.forEach(lang => {
                    locData[lang] = {
                        'IDS_DISPLAY_NAME': packageName
                    };
                });
                const keys = ['IDS_DISPLAY_NAME'];

                const locBuffer = this.buildLocBuffer({ languages, locData, keys });
                const locAsset = {
                    filename: 'localisation.loc',
                    typeCode: 6,
                    dataSize: locBuffer.byteLength,
                    dataOffset: 0,
                    properties: [],
                    data: new Uint8Array(locBuffer)
                };
                this.assets.push(locAsset);

                // UIÊõ¥Êñ∞
                this.currentFilename = `${packageName}.pck`;
                this.updateInfoBar();
                this.displayAssets();
                this.closeNewPackageDialog();

                // „É°„Éã„É•„Éº„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                document.getElementById('menuClose').style.opacity = '1';
                document.getElementById('menuClose').style.pointerEvents = 'auto';

                alert(`Êñ∞„Åó„ÅÑPCK„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${packageName}`);
            }

            openFile() {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput) {
                    console.error('fileInput element not found');
                    alert('„Ç®„É©„Éº: „Éï„Ç°„Ç§„É´ÂÖ•ÂäõË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                console.log('Opening file dialog...');
                fileInput.click();
            }

            saveFile() {
                if (!this.parser || !this.assets.length) {
                    alert('‰øùÂ≠ò„Åô„Çã„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                // „Ç®„É≥„Éá„Ç£„Ç¢„É≥ÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                const endianLittle = document.getElementById('endianLittle');
                const endianBig = document.getElementById('endianBig');
                
                // ÁèæÂú®„ÅÆË®≠ÂÆö„Çí„Éá„Éï„Ç©„É´„Éà„Å®„Åó„Å¶‰øùÊåÅ
                if (this.parser.isLittleEndian) {
                    endianLittle.checked = true;
                } else {
                    endianBig.checked = true;
                }
                
                document.getElementById('saveDialogOverlay').style.display = 'flex';
            }

            closeSaveDialog() {
                document.getElementById('saveDialogOverlay').style.display = 'none';
            }

            async confirmSave() {
                try {
                    const isLittleEndian = document.getElementById('endianLittle').checked;
                    
                    // „Éá„Éï„Ç©„É´„Éà„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
                    const filename = this.currentFilename ? this.currentFilename.replace(/\.pck$/i, '') : 'output';
                    const defaultFilename = filename.endsWith('.pck') ? filename : filename + '.pck';
                    
                    let finalFilename = defaultFilename;
                    let shouldDownload = false;
                    
                    // showSaveFilePicker „Åå‰ΩøÁî®ÂèØËÉΩ„Å™Â†¥ÂêàÔºàChrome/Edge/SafariÔºâ
                    if (window.showSaveFilePicker) {
                        try {
                            const handle = await window.showSaveFilePicker({
                                suggestedName: defaultFilename,
                                types: [{
                                    description: 'PCK Files',
                                    accept: { 'application/octet-stream': ['.pck'] }
                                }]
                            });
                            
                            const writable = await handle.createWritable();
                            const buffer = this.buildPckBuffer(isLittleEndian);
                            await writable.write(buffer);
                            await writable.close();
                            
                            this.closeSaveDialog();
                            alert(`„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ${handle.name}`);
                            return;
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                alert(`„Éï„Ç°„Ç§„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}`);
                            }
                            return;
                        }
                    } else {
                        // Firefox: „Éó„É≠„É≥„Éó„Éà„Åß„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åï„Åõ„Çã
                        const userInput = prompt('„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', defaultFilename);
                        if (userInput === null) return; // „Ç≠„É£„É≥„Çª„É´„ÅÆÂ†¥Âêà
                        
                        finalFilename = userInput.trim() || defaultFilename;
                        if (!finalFilename.endsWith('.pck')) {
                            finalFilename += '.pck';
                        }
                        shouldDownload = true;
                    }
                    
                    // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊñπÂºè„Åß„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
                    if (shouldDownload) {
                        const buffer = this.buildPckBuffer(isLittleEndian);
                        const blob = new Blob([buffer], { type: 'application/octet-stream' });
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = finalFilename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        
                        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´ÔºàdispatchEvent„ÅØFirefox„Åß„Çà„ÇäÁ¢∫ÂÆüÔºâ
                        link.dispatchEvent(new MouseEvent('click', { 
                            bubbles: true,
                            cancelable: true,
                            view: window
                        }));
                        
                        // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            this.closeSaveDialog();
                        }, 100);
                    }
                } catch (error) {
                    alert(`‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            buildPckBuffer(isLittleEndian = null) {
                const little = isLittleEndian !== null ? isLittleEndian : this.parser.isLittleEndian;
                const buffer = new ArrayBuffer(1024 * 1024 * 10);
                const view = new DataView(buffer);
                const writer = {
                    offset: 0,
                    writeUint32: function(value) {
                        view.setUint32(this.offset, value, little);
                        this.offset += 4;
                    },
                    writeString: function(str) {
                        const encoder = new TextEncoder();
                        const bytes = encoder.encode(str);
                        for (let i = 0; i < bytes.length; i++) {
                            view.setUint8(this.offset++, bytes[i]);
                        }
                    },
                    writeStringUTF16: function(str) {
                        const arr = [];
                        for (let i = 0; i < str.length; i++) {
                            const code = str.charCodeAt(i);
                            if (little) {
                                arr.push(code & 0xFF);
                                arr.push((code >> 8) & 0xFF);
                            } else {
                                arr.push((code >> 8) & 0xFF);
                                arr.push(code & 0xFF);
                            }
                        }
                        for (let i = 0; i < arr.length; i++) {
                            view.setUint8(this.offset++, arr[i]);
                        }
                    },
                    writeStringWithPadding: function(str) {
                        const len = str.length;
                        this.writeUint32(len);
                        this.writeStringUTF16(str);
                        this.writeUint32(0); // padding
                    },
                    writeBytes: function(bytes) {
                        for (let i = 0; i < bytes.length; i++) {
                            view.setUint8(this.offset++, bytes[i]);
                        }
                    }
                };

                // pckType
                writer.writeUint32(this.parser.pckType);

                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÈô§Â§ñ„Åó„Åü„Ç¢„Çª„ÉÉ„Éà„É™„Çπ„Éà
                const assetsToSave = this.assets.filter(asset => !asset._isPlaceholder);

                // Property Lookup Table
                const props = new Set();
                assetsToSave.forEach(asset => {
                    asset.properties?.forEach(p => props.add(p.key));
                });
                const propArray = Array.from(props);

                writer.writeUint32(propArray.length);
                propArray.forEach((prop, idx) => {
                    writer.writeUint32(idx); // index
                    writer.writeStringWithPadding(prop);
                });

                // Asset Entries
                writer.writeUint32(assetsToSave.length);
                assetsToSave.forEach(asset => {
                    writer.writeUint32(asset.dataSize);
                    writer.writeUint32(asset.typeCode);
                    writer.writeStringWithPadding(asset.filename);
                });

                // Asset Contents
                assetsToSave.forEach(asset => {
                    const propList = asset.properties || [];
                    writer.writeUint32(propList.length);
                    propList.forEach(prop => {
                        const keyIdx = propArray.indexOf(prop.key);
                        writer.writeUint32(keyIdx);
                        writer.writeStringWithPadding(String(prop.value));
                    });
                    
                    if (asset.data) {
                        writer.writeBytes(new Uint8Array(asset.data));
                    }
                });

                // „Éê„ÉÉ„Éï„Ç°„Çí„Éà„É™„Éü„É≥„Ç∞
                return buffer.slice(0, writer.offset);
            }

            closeFile() {
                if (!this.parser) return;
                
                if (confirm('„Éï„Ç°„Ç§„É´„ÇíÈñâ„Åò„Åæ„Åô„ÅãÔºü')) {
                    this.parser = null;
                    this.assets = [];
                    this.selectedAsset = null;
                    this.currentFilename = '';
                    
                    document.getElementById('infoBar').classList.remove('active');
                    document.getElementById('menuSave').style.opacity = '0.5';
                    document.getElementById('menuSave').style.pointerEvents = 'none';
                    document.getElementById('menuClose').style.opacity = '0.5';
                    document.getElementById('menuClose').style.pointerEvents = 'none';
                    
                    document.getElementById('assetList').innerHTML = `
                        <div class="welcome-screen">
                            <div class="welcome-icon">üì¶</div>
                            <div class="welcome-text">PCK „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</div>
                            <div class="welcome-hint">„Äå„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</div>
                        </div>
                    `;
                    
                    document.getElementById('previewContent').innerHTML = `
                        <div class="empty-message">
                            <div class="empty-icon">üëà</div>
                            Â∑¶ÂÅ¥„Åã„Çâ„Ç¢„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </div>
                    `;
                    
                    document.getElementById('detailsContent').innerHTML = `
                        <div class="empty-message">
                            <div class="empty-icon">‚ÑπÔ∏è</div>
                            „Ç¢„Çª„ÉÉ„ÉàÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
                        </div>
                    `;
                }
            }

            handleFileSelect(file) {
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.pck')) {
                    alert('.pck „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                this.currentFilename = file.name;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.parsePckFile(e.target.result);
                };
                reader.onerror = () => {
                    alert('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº');
                };
                reader.readAsArrayBuffer(file);
            }

            parsePckFile(arrayBuffer) {
                this.parser = new PckParser(arrayBuffer);
                this.assets = this.parser.parse();

                this.updateInfoBar();
                this.displayAssets();
                
                // „É°„Éã„É•„ÉºÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                document.getElementById('menuClose').style.opacity = '1';
                document.getElementById('menuClose').style.pointerEvents = 'auto';
            }

            updateInfoBar() {
                const infoBar = document.getElementById('infoBar');
                infoBar.classList.add('active');
                
                document.getElementById('infoFilename').textContent = this.currentFilename;
                document.getElementById('infoEndian').textContent = this.parser.isLittleEndian ? 'Little Endian' : 'Big Endian';
                document.getElementById('infoPlatform').textContent = this.parser.platformInfo;
                document.getElementById('infoAssetCount').textContent = this.assets.length;
                
                const totalSize = this.assets.reduce((sum, a) => sum + a.dataSize, 0);
                document.getElementById('infoTotalSize').textContent = this.formatSize(totalSize);
            }

            displayAssets() {
                const list = document.getElementById('assetList');
                list.innerHTML = '';
                
                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÈô§Â§ñ„Åó„Åü„Ç¢„Çª„ÉÉ„ÉàÊï∞„ÇíË°®Á§∫
                const visibleAssetCount = this.assets.filter(asset => !asset._isPlaceholder).length;
                document.getElementById('assetCountLabel').textContent = `${visibleAssetCount} „Ç¢„Çª„ÉÉ„Éà`;

                // „Éá„Ç£„É¨„ÇØ„Éà„É™ÊßãÈÄ†„ÇíÊßãÁØâ
                const tree = this.buildDirectoryTree();
                this._currentTree = tree;  // Âæå„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Å´‰øùÂ≠ò
                this.renderTree(list, tree, null, '', null);  // ÊúÄÂæå„ÅÆÂºïÊï∞„Çínull„ÅßÂàùÊúüÂåñ
                
                // Âè§„ÅÑ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
                if (this._rootContextMenuHandler) {
                    list.removeEventListener('contextmenu', this._rootContextMenuHandler);
                }
                
                // „É´„Éº„Éà„É¨„Éô„É´ÔºàÁ©∫ÁôΩ„Ç®„É™„Ç¢Ôºâ„ÅÆÂè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº
                this._rootContextMenuHandler = (e) => {
                    // Â≠êË¶ÅÁ¥†„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºàÁ©∫ÁôΩ„Ç®„É™„Ç¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥ÂêàÔºâ
                    if (e.target === list) {
                        e.preventDefault();
                        this.showContextMenu(e.clientX, e.clientY, {
                            type: 'root',
                            node: { _children: this._currentTree },  // ‰øùÂ≠ò„Åï„Çå„Åü„ÉÑ„É™„Éº„Çí‰ΩøÁî®
                            folderPath: '',
                            currentPckFolder: null
                        });
                    }
                };
                list.addEventListener('contextmenu', this._rootContextMenuHandler);

                // „Éï„Ç©„É´„ÉÄ„ÅÆ„Éà„Ç∞„É´Ê©üËÉΩ„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
                document.querySelectorAll('.asset-folder-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const folder = btn.closest('.asset-folder');
                        const content = folder.querySelector('.asset-folder-content');
                        folder.classList.toggle('expanded');
                        content.style.display = folder.classList.contains('expanded') ? 'block' : 'none';
                    });
                });
            }

            buildDirectoryTree() {
                const tree = {};
                
                // ÈáçË§á„Éï„Ç°„Ç§„É´Âêç„Çí„Ç´„Ç¶„É≥„ÉàÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇÇÂê´„ÇÅ„Å¶„Ç´„Ç¶„É≥„ÉàÔºâ
                const filenameCounts = {};
                this.assets.forEach(asset => {
                    filenameCounts[asset.filename] = (filenameCounts[asset.filename] || 0) + 1;
                });
                
                // ÂêÑ„Éï„Ç°„Ç§„É´Âêç„ÅÆÂá∫ÁèæÂõûÊï∞„ÇíËøΩË∑°
                const filenameIndexes = {};

                // „ÉÑ„É™„ÉºÊßãÈÄ†„ÇíÊßãÁØâÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇÇÂê´„ÇÄÔºâ
                this.assets.forEach((asset, index) => {
                    const duplicateNum = filenameCounts[asset.filename] > 1 
                        ? ` [#${++filenameIndexes[asset.filename] || 1}]`
                        : '';
                    
                    if (asset.filename.includes('/')) {
                        const parts = asset.filename.split('/');
                        let current = tree;
                        
                        // „Éï„Ç©„É´„ÉÄ„Éë„Çπ„ÇíÈÅ°Ëµ∞
                        for (let i = 0; i < parts.length - 1; i++) {
                            const folder = parts[i];
                            if (!current[folder]) {
                                current[folder] = { _type: 'folder', _children: {} };
                            }
                            current = current[folder]._children;
                        }
                        
                        // „Éï„Ç°„Ç§„É´„ÇíËøΩÂä†Ôºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅØÈùûË°®Á§∫Êâ±„ÅÑÔºâ
                        const filename = parts[parts.length - 1];
                        if (!asset._isPlaceholder) {
                            current[filename + duplicateNum] = {
                                _type: 'file',
                                _asset: asset,
                                _index: index
                            };
                        }
                    } else {
                        // „É´„Éº„Éà„É¨„Éô„É´„ÅÆ„Éï„Ç°„Ç§„É´Ôºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÅØÈùûË°®Á§∫Êâ±„ÅÑÔºâ
                        if (!asset._isPlaceholder) {
                            tree[asset.filename + duplicateNum] = {
                                _type: 'file',
                                _asset: asset,
                                _index: index
                            };
                        }
                    }
                    
                    // PCK„Éï„Ç°„Ç§„É´„Åã„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Â≠ê„Ç¢„Çª„ÉÉ„Éà„ÇíËøΩÂä†
                    if (this.isPckFile(asset)) {
                        const childAssets = this.parsePckAsset(asset);
                        if (childAssets && childAssets.length > 0) {
                            // PCK„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´Âêç„Çí„Éï„Ç©„É´„ÉÄ„Å®„Åó„Å¶Êâ±„ÅÜ
                            const folderKey = asset.filename + duplicateNum;
                            let current = tree;
                            
                            if (asset.filename.includes('/')) {
                                const parts = asset.filename.split('/');
                                for (let i = 0; i < parts.length - 1; i++) {
                                    const folder = parts[i];
                                    if (!current[folder]) {
                                        current[folder] = { _type: 'folder', _children: {} };
                                    }
                                    current = current[folder]._children;
                                }
                                const filename = parts[parts.length - 1];
                                if (!current[filename + duplicateNum]) {
                                    current[filename + duplicateNum] = { _type: 'pck-folder', _children: {}, _asset: asset };
                                } else {
                                    // Êó¢Â≠ò„ÅÆ„Éï„Ç°„Ç§„É´„Éé„Éº„Éâ„Çí PCK „Éï„Ç©„É´„ÉÄ„Å´Â§âÊèõ
                                    current[filename + duplicateNum]._type = 'pck-folder';
                                    current[filename + duplicateNum]._children = {};
                                    current[filename + duplicateNum]._asset = asset;
                                }
                                current = current[filename + duplicateNum]._children;
                            } else {
                                if (!tree[folderKey]) {
                                    tree[folderKey] = { _type: 'pck-folder', _children: {}, _asset: asset };
                                } else if (tree[folderKey]._type === 'file') {
                                    tree[folderKey]._type = 'pck-folder';
                                    tree[folderKey]._children = {};
                                }
                                current = tree[folderKey]._children;
                            }
                            
                            // Â≠ê„Ç¢„Çª„ÉÉ„Éà„Çí„ÉÑ„É™„Éº„Å´ËøΩÂä†ÔºàË¶™PCKÊÉÖÂ†±„ÇÇÊ∏°„ÅôÔºâ
                            this.addChildAssetsToTree(current, childAssets, asset.filename, '', { asset: asset, index: index });
                        }
                    }
                });

                return tree;
            }

            addChildAssetsToTree(current, childAssets, parentPath, parentPathForFiles = '', parentPckInfo = null) {
                const filenameCounts = {};
                childAssets.forEach(asset => {
                    filenameCounts[asset.filename] = (filenameCounts[asset.filename] || 0) + 1;
                });
                
                const filenameIndexes = {};
                
                // ÊúÄÂàù„ÅÆÂëº„Å≥Âá∫„Åó„ÅÆÂ†¥Âêà„ÄÅ„Éï„Ç°„Ç§„É´Ë¶™„Éë„Çπ„Çí„Çª„ÉÉ„Éà
                if (!parentPathForFiles) {
                    parentPathForFiles = parentPath;
                }
                
                childAssets.forEach((asset, index) => {
                    const duplicateNum = filenameCounts[asset.filename] > 1 
                        ? ` [#${++filenameIndexes[asset.filename] || 1}]`
                        : '';
                    
                    if (asset.filename.includes('/')) {
                        const parts = asset.filename.split('/');
                        let node = current;
                        let accumulatedPath = parentPathForFiles;
                        
                        for (let i = 0; i < parts.length - 1; i++) {
                            const folder = parts[i];
                            accumulatedPath = accumulatedPath + '/' + folder;
                            if (!node[folder]) {
                                // „Éï„Ç©„É´„ÉÄ‰ΩúÊàêÊôÇ„Å´ÂÆåÂÖ®„Å™„Éë„Çπ„Å®Ë¶™PCKÊÉÖÂ†±„Çí‰øùÊåÅ
                                node[folder] = { 
                                    _type: 'folder', 
                                    _children: {},
                                    _fullPath: accumulatedPath,
                                    _parentPckInfo: parentPckInfo
                                };
                            } else if (parentPckInfo && !node[folder]._parentPckInfo) {
                                // Êó¢Â≠ò„ÅÆ„Éï„Ç©„É´„ÉÄ„Å´„ÇÇË¶™PCKÊÉÖÂ†±„ÇíË®≠ÂÆö
                                node[folder]._parentPckInfo = parentPckInfo;
                            }
                            node = node[folder]._children;
                        }
                        
                        const filename = parts[parts.length - 1];
                        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éï„Ç°„Ç§„É´„Éé„Éº„Éâ„ÇíËøΩÂä†
                        if (!asset._isPlaceholder) {
                            node[filename + duplicateNum] = {
                                _type: 'file',
                                _asset: asset,
                                _parentPath: parentPathForFiles,
                                _parentPckInfo: parentPckInfo,
                                _childIndex: index
                            };
                        }
                    } else {
                        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éï„Ç°„Ç§„É´„Éé„Éº„Éâ„ÇíËøΩÂä†
                        if (!asset._isPlaceholder) {
                            current[asset.filename + duplicateNum] = {
                                _type: 'file',
                                _asset: asset,
                                _parentPath: parentPathForFiles,
                                _parentPckInfo: parentPckInfo,
                                _childIndex: index
                            };
                        }
                    }
                    
                    // ÂÜçÂ∏∞ÁöÑ„Å´PCK„Éï„Ç°„Ç§„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (this.isPckFile(asset)) {
                        const grandchildAssets = this.parsePckAsset(asset);
                        if (grandchildAssets && grandchildAssets.length > 0) {
                            const nodeKey = asset.filename.includes('/') 
                                ? asset.filename.split('/').pop() + duplicateNum
                                : asset.filename + duplicateNum;
                            
                            let targetNode = current;
                            if (asset.filename.includes('/')) {
                                const parts = asset.filename.split('/');
                                for (let i = 0; i < parts.length - 1; i++) {
                                    targetNode = targetNode[parts[i]]._children;
                                }
                            }
                            
                            if (targetNode[nodeKey]._type === 'file') {
                                targetNode[nodeKey]._type = 'pck-folder';
                                targetNode[nodeKey]._children = {};
                            }
                            if (!targetNode[nodeKey]._children) {
                                targetNode[nodeKey]._children = {};
                            }
                            
                            // Â≠´„Ç¢„Çª„ÉÉ„Éà„Å´„ÅØ„ÄÅ„Åì„ÅÆ„Ç¢„Çª„ÉÉ„ÉàËá™‰Ωì„ÇíparentPckInfo„Å®„Åó„Å¶Ê∏°„Åô
                            const nestedPckInfo = { asset: asset, index: null };
                            const nextParentPath = parentPath + '/' + asset.filename;
                            const nextPathForFiles = parentPathForFiles + '/' + asset.filename;
                            this.addChildAssetsToTree(targetNode[nodeKey]._children, grandchildAssets, nextParentPath, nextPathForFiles, nestedPckInfo);
                        }
                    }
                });
            }

            isPckFile(asset) {
                // typeCode „Åå 5, 8, 11 „ÅÆÂ†¥Âêà„ÅØ PCK „Éï„Ç°„Ç§„É´
                return asset.typeCode === 5 || asset.typeCode === 8 || asset.typeCode === 11;
            }

            parsePckAsset(asset) {
                try {
                    let assetData;
                    
                    // Êõ¥Êñ∞„Åï„Çå„Åü„Ç¢„Çª„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÄÅasset.data„Çí‰ΩøÁî®
                    if (asset.data && asset.data.byteLength > 0) {
                        assetData = asset.data;
                    } else {
                        // ÂÖÉ„ÅÆ„Éê„ÉÉ„Éï„Ç°„Åã„ÇâË™≠„ÅøËæº„Åø
                        assetData = new Uint8Array(this.parser.buffer, asset.dataOffset, asset.dataSize);
                    }
                    
                    // Êñ∞„Åó„ÅÑ ArrayBuffer „Çí‰ΩúÊàêÔºàÁã¨Á´ã„Åó„Åü buffer „Å´„Åô„ÇãÔºâ
                    const newBuffer = new ArrayBuffer(assetData.byteLength);
                    new Uint8Array(newBuffer).set(assetData);
                    
                    // PCK „Å®„Åó„Å¶Ëß£Êûê
                    const childParser = new PckParser(newBuffer);
                    const childAssets = childParser.parse();
                    
                    return childAssets;
                } catch (e) {
                    console.warn(`Failed to parse PCK asset: ${asset.filename}`, e);
                    return null;
                }
            }

            renderTree(parentElement, tree, parentNode, currentPath, currentPckFolder = null) {
                Object.keys(tree).sort().forEach(key => {
                    const node = tree[key];
                    // PCKÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ„Åß _fullPath „Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ currentPath „ÇíÁ¥ØÁ©ç
                    let nodePath;
                    let nextPckFolder = currentPckFolder;
                    
                    if (node._type === 'pck-folder') {
                        // „Åì„ÅÆ„Éé„Éº„Éâ„ÅåPCK-folder „ÅÆÂ†¥Âêà„ÄÅÊ¨°„ÅÆ„É¨„Éô„É´„Åß„ÅØ„Åì„Çå„ÅåÂü∫Ê∫ñ„Å´„Å™„Çã
                        nextPckFolder = key;
                    }
                    
                    if (node._fullPath !== undefined) {
                        // PCKÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ„ÅßÂÆåÂÖ®„Å™„Éë„Çπ„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÔºà„Éï„Ç©„É´„ÉÄÂêç„ÇíÂê´„ÇÄÔºâ
                        nodePath = node._fullPath + '/';
                    } else if (node._parentPath !== undefined) {
                        // PCKÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ„Å†„Åå _fullPath „Åå„Å™„ÅÑÂ†¥ÂêàÔºàPCKÁõ¥‰∏ãÔºâ
                        nodePath = node._parentPath + '/' + key + '/';
                    } else {
                        // ÈÄöÂ∏∏„ÅÆ„Éï„Ç©„É´„ÉÄ
                        nodePath = currentPath ? currentPath + key + '/' : key + '/';
                    }
                    
                    if (node._type === 'folder' || node._type === 'pck-folder') {
                        const folderDiv = document.createElement('div');
                        folderDiv.className = 'asset-folder expanded';
                        
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'asset-folder-toggle';
                        const icon = node._type === 'pck-folder' ? 'üì¶' : 'üìÅ';
                        toggleBtn.innerHTML = '‚ñº ' + icon + ' ' + this.escapeHtml(key);
                        toggleBtn.title = key;
                        
                        // „Éï„Ç©„É´„ÉÄ„Å∏„ÅÆÂè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº
                        // PCK-folder „Å´„ÅØÂè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº„ÇíË°®Á§∫„Åó„Å™„ÅÑ
                        if (node._type !== 'pck-folder') {
                            folderDiv.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                let contextFolderPath = nodePath;
                                if (currentPckFolder !== null) {
                                    const pckRelativePath = nodePath.substring((currentPckFolder + '/').length);
                                    contextFolderPath = pckRelativePath;
                                }
                                
                                this.showContextMenu(e.clientX, e.clientY, {
                                    type: 'folder',
                                    name: key,
                                    node: node,
                                    parentNode: parentNode,
                                    folderPath: contextFolderPath,
                                    currentPckFolder: currentPckFolder,
                                    parentPckInfo: node._parentPckInfo,
                                    parent: parentElement
                                });
                            });
                        }
                        
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'asset-folder-content';
                        contentDiv.style.display = 'block';
                        
                        folderDiv.appendChild(toggleBtn);
                        folderDiv.appendChild(contentDiv);
                        parentElement.appendChild(folderDiv);
                        
                        this.renderTree(contentDiv, node._children, node, nodePath, nextPckFolder);
                    } else {
                        // „Éï„Ç°„Ç§„É´
                        const asset = node._asset;
                        const index = node._index;
                        
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'asset-item';
                        
                        // „ÇØ„É©„ÉÉ„Ç∑„É•„Çπ„Ç≠„É≥„Éª„Éû„É≥„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                        const MAX_SIZE = 0x7FFF;
                        const isSkinOrCape = asset.typeCode === 0 || asset.typeCode === 1;
                        if (isSkinOrCape && asset.dataSize > MAX_SIZE) {
                            fileDiv.className += ' crash-warning';
                        }
                        
                        const icon = this.getAssetTypeIcon(asset);
                        const displayName = key;
                        
                        let indexDisplay = '';
                        if (index !== undefined && index !== null) {
                            indexDisplay = `[${index}] `;
                        }
                        
                        fileDiv.innerHTML = `
                            <div class="asset-filename">
                                <span class="asset-type-icon">${icon}</span>
                                <span class="asset-file">${this.escapeHtml(displayName)}</span>
                            </div>
                            <div class="asset-info">
                                ${indexDisplay}Type ${asset.typeCode} ‚Ä¢ ${this.formatSize(asset.dataSize)}
                            </div>
                            ${index !== undefined && index !== null ? `<button class="asset-delete-btn" onclick="event.stopPropagation(); viewer.deleteAsset(${index})" title="„Åì„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÇíÂâäÈô§">‚úï</button>` : ''}
                        `;
                        
                        // „Éï„Ç°„Ç§„É´„Å∏„ÅÆÂè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº
                        fileDiv.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            e.stopPropagation(); // Ë¶™Ë¶ÅÁ¥†„Å∏„ÅÆ‰ºùÊí≠„ÇíÊ≠¢„ÇÅ„Çã
                            // PCKÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÄÅPCKÁõ∏ÂØæ„Éë„Çπ„ÇíË®àÁÆó
                            let contextFolderPath = currentPath;
                            if (currentPckFolder !== null) {
                                // PCKÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà
                                const pckRelativePath = currentPath.substring((currentPckFolder + '/').length);
                                contextFolderPath = pckRelativePath;
                            }
                            
                            this.showContextMenu(e.clientX, e.clientY, {
                                type: 'file',
                                name: key,
                                asset: asset,
                                index: index,
                                parentNode: parentNode,
                                folderPath: contextFolderPath,
                                currentPckFolder: currentPckFolder,
                                parentPckInfo: node._parentPckInfo,
                                childIndex: node._childIndex
                            });
                        });
                        
                        fileDiv.addEventListener('click', () => this.selectAsset(asset, fileDiv, index));
                        parentElement.appendChild(fileDiv);
                    }
                });
            }

            getAssetTypeIcon(asset) {
                // typeCode„ÅßÂà§ÂÆö
                switch (asset.typeCode) {
                    case 0:
                        return 'üë§'; // „Çπ„Ç≠„É≥
                    case 1:
                        return 'üß•'; // „Éû„É≥„Éà
                    case 4:
                        return 'üì¶'; // PACKID
                    case 6:
                        return 'üåê'; // LOCÔºàË®ÄË™û„Éï„Ç°„Ç§„É´Ôºâ
                    default:
                        // „Åù„ÅÆ‰ªñ„ÅØ„Éï„Ç°„Ç§„É´Âêç„ÅßÂà§ÂÆö
                        const filename = asset.filename.toLowerCase();
                        if (filename.endsWith('.json')) {
                            return 'üìã';
                        }
                        if (filename.endsWith('.png')) {
                            return 'üñºÔ∏è';
                        }
                        return 'üìÑ';
                }
            }

            selectAsset(asset, element, index) {
                this.selectedAsset = asset;
                this.selectedAssetIndex = index;

                // „É¢„Éê„Ç§„É´„Åß„Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
                if (window.innerWidth <= 768) {
                    this.closeSidebar();
                }

                document.querySelectorAll('.asset-item').forEach(item => {
                    item.classList.remove('selected');
                });
                element.classList.add('selected');

                this.displayPreview(asset);
                this.displayDetails(asset);
            }

            displayPreview(asset) {
                const header = document.getElementById('previewHeader');
                const content = document.getElementById('previewContent');

                let indexText = '';
                if (this.selectedAssetIndex !== undefined) {
                    indexText = `[${this.selectedAssetIndex}] `;
                } else {
                    const foundIndex = this.assets.indexOf(asset);
                    if (foundIndex !== -1) {
                        indexText = `[${foundIndex}] `;
                    }
                }
                header.textContent = `„Éó„É¨„Éì„É•„Éº - ${indexText}${asset.filename}`;

                if (asset.dataSize === 0) {
                    content.innerHTML = '<div class="empty-message"><div class="empty-icon">üì≠</div>„Éá„Éº„Çø„Å™„Åó</div>';
                    return;
                }

                // .loc „Éï„Ç°„Ç§„É´„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (asset.filename.toLowerCase().endsWith('.loc')) {
                    this.displayLocPreview(asset, content);
                    return;
                }

                // ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆ„Éó„É¨„Éì„É•„Éº
                if (asset.filename.toLowerCase().match(/\.(png|jpg|jpeg|gif|bmp)$/)) {
                    this.displayImagePreview(asset, content);
                    return;
                }

                // HEX „Éó„É¨„Éì„É•„Éº
                const data = asset.data || new Uint8Array(this.parser.buffer, asset.dataOffset, Math.min(512, asset.dataSize));
                let hex = '';
                for (let i = 0; i < Math.min(512, data.length); i += 16) {
                    const chunk = Array.from(data.slice(i, i + 16))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(' ');
                    const ascii = Array.from(data.slice(i, i + 16))
                        .map(b => b >= 32 && b < 127 ? String.fromCharCode(b) : '.')
                        .join('');
                    hex += `${(asset.dataOffset + i).toString(16).padStart(8, '0')}  ${chunk.padEnd(48)}  ${ascii}\n`;
                }

                content.innerHTML = `<div class="preview-hex">${hex}</div>`;
            }

            displayLocPreview(asset, container) {
                try {
                    const locData = asset.data || new Uint8Array(this.parser.buffer, asset.dataOffset, asset.dataSize);
                    const locParser = new LOCParser(locData.buffer.slice(locData.byteOffset, locData.byteOffset + locData.byteLength));
                    const result = locParser.parse();

                    if (!result) {
                        container.innerHTML = '<div class="empty-message"><div class="empty-icon">‚ùå</div>LOC„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                        return;
                    }

                    // LOC„Éá„Éº„Çø„Çí‰øùÂ≠ò
                    this.currentLocData = result;
                    this.selectedLocKey = null;
                    const { languages, locData: entries } = result;
                    
                    console.log('=== LOC Display ===');
                    console.log('Ë®ÄË™ûÊï∞:', languages.length);
                    console.log('Ë®ÄË™û„É™„Çπ„Éà:', languages);
                    console.log('locData„ÅÆË®ÄË™û:', Object.keys(entries));

                    const allKeys = new Set();
                    Object.values(entries).forEach(langEntries => {
                        Object.keys(langEntries).forEach(key => allKeys.add(key));
                    });
                    // „Ç¢„Çª„ÉÉ„Éà‰∏ÄË¶ß„ÅÆÈ†ÜÂ∫è„Çí‰øùÊåÅÔºà„ÇΩ„Éº„Éà„Åó„Å™„ÅÑÔºâ
                    const keyList = Array.from(allKeys);

                    let html = '<div class="loc-editor-container">';
                    
                    // Â∑¶ÂÅ¥: „Ç≠„Éº„É™„Çπ„Éà
                    html += '<div class="loc-keys-panel">';
                    keyList.forEach(key => {
                        // dataÂ±ûÊÄß„Åß„Ç≠„Éº„ÇíÊ∏°„Åô
                        html += `<div class="loc-key-item" data-loc-key="${this.escapeAttr(key)}" onclick="viewer.selectLocKeyFromElement(this)">
                            ${this.escapeHtml(key)}
                        </div>`;
                    });
                    html += '</div>';
                    
                    // Âè≥ÂÅ¥: Ë©≥Á¥∞„Éë„Éç„É´
                    html += '<div class="loc-detail-panel">';
                    html += '<div class="loc-no-selection">‚Üê Â∑¶ÂÅ¥„Åã„Çâ„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
                    html += '</div>';
                    
                    html += '</div>';
                    
                    container.innerHTML = html;
                } catch (error) {
                    console.error('LOC Preview Error:', error);
                    container.innerHTML = `<div class="empty-message"><div class="empty-icon">‚ùå</div>LOCËß£Êûê„Ç®„É©„Éº: ${error.message}</div>`;
                }
            }

            selectLocKeyFromElement(element) {
                // dataÂ±ûÊÄß„Åã„Çâ„Ç≠„Éº„ÇíÂèñÂæó
                const key = element.dataset.locKey;
                this.selectLocKey(key);
            }

            selectLocKey(key) {
                if (!this.currentLocData) return;
                
                this.selectedLocKey = key;
                const { languages, locData: entries } = this.currentLocData;
                
                console.log('selectLocKey:', key);
                console.log('Âà©Áî®ÂèØËÉΩ„Å™Ë®ÄË™û:', languages);
                console.log('ÂêÑË®ÄË™û„ÅÆ„Éá„Éº„Çø:');
                languages.forEach(lang => {
                    console.log(`  ${lang}:`, entries[lang]?.[key]);
                });
                
                // „Ç≠„Éº„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Éè„Ç§„É©„Ç§„Éà
                document.querySelectorAll('.loc-key-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.dataset.locKey === key) {
                        item.classList.add('selected');
                    }
                });
                
                // Ë©≥Á¥∞„Éë„Éç„É´„ÇíÊõ¥Êñ∞
                const detailPanel = document.querySelector('.loc-detail-panel');
                let html = '';
                
                // ‰∏ÄÊã¨ÁΩÆÊèõUI
                html += '<div class="loc-bulk-replace">';
                html += '<div class="loc-bulk-replace-title">‚ú® „Åô„Åπ„Å¶„ÅÆË®ÄË™û„Å´‰∏ÄÊã¨ÈÅ©Áî®</div>';
                html += '<div class="loc-bulk-replace-input">';
                html += `<input type="text" id="locBulkReplaceInput" placeholder="„Åô„Åπ„Å¶„ÅÆË®ÄË™û„Å´ÈÅ©Áî®„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà">`;
                html += `<button class="loc-bulk-replace-btn" onclick="viewer.applyBulkReplace()">‰∏ÄÊã¨ÈÅ©Áî®</button>`;
                html += '</div>';
                html += '</div>';
                
                // ÂêÑË®ÄË™û„ÅÆÂÄ§
                html += '<div class="loc-values-container">';
                languages.forEach(lang => {
                    const value = entries[lang]?.[key] || '';
                    html += '<div class="loc-value-edit-row">';
                    html += `<div class="loc-lang-label-edit">${this.escapeHtml(lang)}</div>`;
                    html += `<input type="text" class="loc-value-edit-input" 
                                   value="${this.escapeAttr(value)}" 
                                   data-key="${this.escapeAttr(key)}" 
                                   data-lang="${this.escapeAttr(lang)}"
                                   onchange="viewer.updateLocValue(this)">`;
                    html += '</div>';
                });
                html += '</div>';
                
                detailPanel.innerHTML = html;
            }

            applyBulkReplace() {
                if (!this.currentLocData || !this.selectedLocKey) return;
                
                const bulkValue = document.getElementById('locBulkReplaceInput').value;
                const { languages } = this.currentLocData;
                
                // „Åô„Åπ„Å¶„ÅÆË®ÄË™û„Å´Âêå„ÅòÂÄ§„ÇíË®≠ÂÆö
                languages.forEach(lang => {
                    if (!this.currentLocData.locData[lang]) {
                        this.currentLocData.locData[lang] = {};
                    }
                    this.currentLocData.locData[lang][this.selectedLocKey] = bulkValue;
                });
                
                // LOC„Éê„ÉÉ„Éï„Ç°„ÇíÂÜçÊßãÁØâ
                this.rebuildLocBuffer();
                
                // UI„ÇíÂÜçÊèèÁîª
                this.selectLocKey(this.selectedLocKey);
                
                alert(`„Äå${this.selectedLocKey}„Äç„Çí„Åô„Åπ„Å¶„ÅÆË®ÄË™û„Å´ÈÅ©Áî®„Åó„Åæ„Åó„Åü`);
            }

            rebuildLocBuffer() {
                if (!this.currentLocData || !this.selectedAsset) return;
                
                try {
                    // keys„ÇíÊõ¥Êñ∞
                    const allKeys = new Set(this.currentLocData.keys);
                    Object.values(this.currentLocData.locData).forEach(langEntries => {
                        Object.keys(langEntries).forEach(key => allKeys.add(key));
                    });
                    const updatedKeys = Array.from(allKeys);
                    
                    const newBuffer = this.buildLocBuffer({
                        ...this.currentLocData,
                        keys: updatedKeys
                    });
                    this.selectedAsset.data = new Uint8Array(newBuffer);
                    this.selectedAsset.dataSize = newBuffer.byteLength;
                    
                    // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                    document.getElementById('menuSave').style.opacity = '1';
                    document.getElementById('menuSave').style.pointerEvents = 'auto';
                } catch (error) {
                    console.error('LOCÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                    alert(`LOC„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
                }
            }

            displayImagePreview(asset, container) {
                try {
                    const imageData = asset.data || new Uint8Array(this.parser.buffer, asset.dataOffset, asset.dataSize);
                    
                    // Blob URL „ÅÆ‰ª£„Çè„Çä„Å´ Data URL „Çí‰ΩøÁî®ÔºàURL„ÅÆÊúâÂäπÊúüÈôêÂïèÈ°å„ÇíÈÅø„Åë„ÇãÔºâ
                    const base64 = btoa(String.fromCharCode.apply(null, imageData));
                    const dataUrl = 'data:image/png;base64,' + base64;

                    // ÁîªÂÉè„ÇíË™≠„ÅøËæº„Çì„Åß„Çµ„Ç§„Ç∫„ÇíÁ¢∫Ë™ç
                    const img = new Image();
                    img.onload = () => {
                        // Â∞è„Åï„ÅÑÁîªÂÉè„ÅØËá™ÂãïÊã°Â§ßÔºà64x64„ÅÆ„Çπ„Ç≠„É≥„Å™„Å©Ôºâ
                        let displayWidth = img.width;
                        let displayHeight = img.height;
                        
                        // ÁîªÂÉè„Åå300pxÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØÊã°Â§ß
                        if (img.width < 300 || img.height < 300) {
                            // ÊúÄ‰Ωé„Åß„ÇÇÂπÖ300px„Å´„Å™„Çã„Çà„ÅÜ„Å´Êã°Â§ß
                            const scale = Math.max(Math.ceil(300 / img.width), Math.ceil(300 / img.height));
                            displayWidth = img.width * scale;
                            displayHeight = img.height * scale;
                        }
                        
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <img src="${dataUrl}" 
                                     style="width: ${displayWidth}px; height: ${displayHeight}px; max-width: 100%; height: auto; image-rendering: pixelated; border: 1px solid #3e3e42; background: repeating-conic-gradient(#2a2a2a 0% 25%, #1e1e1e 0% 50%) 50% / 20px 20px;" />
                                <div style="color: #858585; font-size: 11px;">
                                    ÂÖÉ„Çµ„Ç§„Ç∫: ${img.width} √ó ${img.height} px
                                    ${displayWidth !== img.width ? ` ‚Üí Êã°Â§ßË°®Á§∫: ${displayWidth} √ó ${displayHeight} px` : ''}
                                </div>
                            </div>
                        `;
                    };
                    
                    img.onerror = () => {
                        container.innerHTML = '<div class="empty-message"><div class="empty-icon">üñºÔ∏è</div>ÁîªÂÉè„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    };
                    
                    img.src = dataUrl;
                } catch (error) {
                    container.innerHTML = '<div class="empty-message"><div class="empty-icon">üñºÔ∏è</div>ÁîªÂÉè„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                }
            }

            displayDetails(asset) {
                const container = document.getElementById('detailsContent');

                let html = '';
                
                // „Çπ„Ç≠„É≥„Éª„Éû„É≥„Éà„ÅÆ„Çµ„Ç§„Ç∫Ë≠¶Âëä„ÉÅ„Çß„ÉÉ„ÇØÔºà0x7FFF = 32767„Éê„Ç§„ÉàÔºâ
                const MAX_SIZE = 0x7FFF;
                const isSkinOrCape = asset.typeCode === 0 || asset.typeCode === 1;
                const isOversized = isSkinOrCape && asset.dataSize > MAX_SIZE;
                
                if (isOversized) {
                    const typeName = asset.typeCode === 0 ? '„Çπ„Ç≠„É≥' : '„Éû„É≥„Éà';
                    html += `<div style="background: #5a1f1f; border: 2px solid #d32f2f; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                        <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è „ÇØ„É©„ÉÉ„Ç∑„É•Ë≠¶Âëä</div>
                        <div style="color: #d4d4d4; font-size: 12px; line-height: 1.6;">
                            „Åì„ÅÆ${typeName}„ÅÆ„Çµ„Ç§„Ç∫„ÅØ <strong>${asset.dataSize} „Éê„Ç§„ÉàÔºà0x${asset.dataSize.toString(16).toUpperCase()}Ôºâ</strong>„Åß„Åô„ÄÇ<br>
                            0x7FFFÔºà${MAX_SIZE}„Éê„Ç§„ÉàÔºâ„ÇíË∂Ö„Åà„Çã${typeName}„ÅØ„Ç≤„Éº„É†ÂÜÖ„Åß„ÇØ„É©„ÉÉ„Ç∑„É•„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
                        </div>
                    </div>`;
                }
                
                if (asset.properties && asset.properties.length > 0) {
                    html += '<div class="properties-list">';
                    asset.properties.forEach((prop, index) => {
                        html += `<div class="property-item">
                            <input type="text" class="property-key-input" 
                                   value="${this.escapeHtml(prop.key)}" 
                                   data-index="${index}"
                                   data-type="key"
                                   onchange="viewer.updateProperty(this)">
                            <input type="text" class="property-value-input" 
                                   value="${this.escapeHtml(prop.value)}" 
                                   data-index="${index}"
                                   data-type="value"
                                   onchange="viewer.updateProperty(this)">
                            <button class="property-delete-btn" onclick="viewer.deleteProperty(${index})" title="„Åì„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂâäÈô§">‚úï</button>
                        </div>`;
                    });
                    html += '</div>';
                    
                    // „Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†„Éú„Çø„É≥
                    html += `<button class="btn-asset-action" onclick="viewer.addProperty()">‚ûï „Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†</button>`;
                    
                    // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
                    html += '<div class="asset-action-buttons">';
                    html += '</div>';
                } else {
                    html += `<div class="empty-message"><div class="empty-icon">üìã</div>„Éó„É≠„Éë„ÉÜ„Ç£„Å™„Åó</div>`;
                    html += `<button class="btn-asset-action" onclick="viewer.addProperty()">‚ûï „Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†</button>`;
                }

                container.innerHTML = html;
            }

            formatSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            escapeAttr(text) {
                // HTMLÂ±ûÊÄßÂÄ§Áî®„ÅÆ„Ç®„Çπ„Ç±„Éº„ÉóÔºàÂà∂Âæ°ÊñáÂ≠ó„ÇíÊï∞ÂÄ§ÊñáÂ≠óÂèÇÁÖß„Å´Â§âÊèõÔºâ
                return this.escapeHtml(text)
                    .replace(/\n/g, '&#10;')
                    .replace(/\r/g, '&#13;')
                    .replace(/\t/g, '&#9;');
            }

            showSkinSelector() {
                const modal = document.getElementById('importModal');
                document.getElementById('skinFileInput').value = '';
                document.getElementById('skinNameInput').value = '';
                document.getElementById('skinThemeInput').value = '';
                document.getElementById('skinIdInput').value = '';
                document.getElementById('skinModelInput').value = 'steve';
                document.getElementById('capeFileInput').value = '';
                document.getElementById('skinPreviewArea').style.display = 'none';
                document.getElementById('capePreviewArea').style.display = 'none';
                modal.classList.add('active');
            }

            showTypeSelector(type) {
                // „Çπ„Ç≠„É≥/„Éû„É≥„Éà„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÇíÊäΩÂá∫
                const items = this.assets.filter(asset => {
                    // FREE „Éó„É≠„Éë„ÉÜ„Ç£„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàFREE=1„ÅØÈÅ∏Êäû‰∏çÂèØÔºâ
                    const hasFree = asset.properties && asset.properties.some(p => p.key === 'FREE' && p.value === '1');
                    if (hasFree) return false;
                    
                    // „Çπ„Ç≠„É≥„Åæ„Åü„ÅØ„Éû„É≥„Éà„ÅÆ„Åø„ÇíÂØæË±°
                    const name = asset.filename.toLowerCase();
                    if (type === 'skin') {
                        return name.endsWith('.png') && !name.includes('cape') && !name.includes('elytra');
                    } else { // cape
                        return (name.includes('cape') || name.includes('elytra')) && name.endsWith('.png');
                    }
                });

                // „É¢„Éº„ÉÄ„É´ÂÜÖÂÆπ„ÇíÁîüÊàê
                let html = '';
                if (items.length === 0) {
                    html = '<div class="empty-message"><div class="empty-icon">üì≠</div>Ë©≤ÂΩì„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                } else {
                    html = items.map((item, idx) => {
                        const anim = item.properties?.find(p => p.key === 'ANIM')?.value || '-';
                        let modelType = 'Unknown';
                        if (anim) {
                            if (anim === '0x00080000' || anim === '524288') modelType = 'Alex';
                            else if (anim === '0x00040000' || anim === '262144') modelType = 'Steve';
                        }
                        
                        // „Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÂê´„ÇÄ„Éï„Ç°„Ç§„É´„Éë„Çπ„ÅÆÂá¶ÁêÜ
                        let filenameHtml = '';
                        if (item.filename.includes('/')) {
                            const parts = item.filename.split('/');
                            const filename = parts[parts.length - 1];
                            const directory = parts.slice(0, -1).join('/');
                            filenameHtml = `<span class="skin-item-dir">${this.escapeHtml(directory)}/</span><span class="skin-item-file">${this.escapeHtml(filename)}</span>`;
                        } else {
                            filenameHtml = `<span class="skin-item-file">${this.escapeHtml(item.filename)}</span>`;
                        }
                        
                        return `
                            <div class="skin-item" onclick="viewer.selectItem(${idx}, '${type}', '${this.escapeHtml(item.filename)}')">
                                <div class="skin-item-name">${filenameHtml}</div>
                                <div class="skin-item-info">Model: ${modelType} ‚Ä¢ Size: ${this.formatSize(item.dataSize)}</div>
                            </div>
                        `;
                    }).join('');
                }

                const modal = document.getElementById('skinModal');
                const title = document.getElementById('skinModalTitle');
                const content = document.getElementById('skinModalContent');
                
                title.textContent = type === 'skin' ? '„Çπ„Ç≠„É≥„ÇíÈÅ∏Êäû' : '„Éû„É≥„Éà„ÇíÈÅ∏Êäû';
                content.innerHTML = html;
                modal.classList.add('active');
            }

            selectItem(index, type, filename) {
                const items = this.assets.filter(asset => {
                    const hasFree = asset.properties && asset.properties.some(p => p.key === 'FREE' && p.value === '1');
                    if (hasFree) return false;
                    const name = asset.filename.toLowerCase();
                    if (type === 'skin') {
                        return name.endsWith('.png') && !name.includes('cape') && !name.includes('elytra');
                    } else {
                        return (name.includes('cape') || name.includes('elytra')) && name.endsWith('.png');
                    }
                });

                const selected = items[index];
                if (!selected) return;

                // „Çπ„Ç≠„É≥ÈÅ∏ÊäûÂæå„ÅÆÂá¶ÁêÜ
                alert(`${type === 'skin' ? '„Çπ„Ç≠„É≥' : '„Éû„É≥„Éà'}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü: ${filename}\\n(ÂÆüË£Ö‰∫àÂÆö)`);
                this.closeSkinModal();
            }

            closeSkinModal() {
                const modal = document.getElementById('skinModal');
                modal.classList.remove('active');
            }

            showContextMenu(x, y, data) {
                const menu = document.getElementById('contextMenu');
                menu.innerHTML = '';
                menu.classList.remove('hidden');
                
                const items = [];
                
                if (data.type === 'file') {
                    items.push({
                        label: '„Çπ„Ç≠„É≥„ÇíËøΩÂä†',
                        action: () => this.addSkinToFolder(data.parentNode, data.folderPath, data.currentPckFolder)
                    });
                    
                    // „Çπ„Ç≠„É≥„Åæ„Åü„ÅØPNG„Éï„Ç°„Ç§„É´„ÅÆÂ†¥Âêà„ÄÅÁΩÆ„ÅçÊèõ„Åà„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
                    const isPngOrSkin = data.asset.typeCode === 0 || data.asset.filename.toLowerCase().endsWith('.png');
                    if (isPngOrSkin) {
                        items.push({
                            label: 'ÁîªÂÉè„ÇíÁΩÆ„ÅçÊèõ„Åà',
                            action: () => this.replaceAssetImage(data.asset, data.parentPckInfo, data.childIndex)
                        });
                    }
                    
                    items.push({ divider: true });
                    items.push({
                        label: 'ÂâäÈô§',
                        action: () => this.deleteMenuItem(data.index, data.parentPckInfo, data.childIndex, data.asset)
                    });
                } else if (data.type === 'folder') {
                    // „Éï„Ç©„É´„ÉÄ„Å∏„ÅÆ„É°„Éã„É•„Éº
                    items.push({
                        label: '„Çπ„Ç≠„É≥„ÇíËøΩÂä†',
                        action: () => this.addSkinToFolder(data.node, data.folderPath, data.currentPckFolder)
                    });
                    items.push({
                        label: '„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê',
                        action: () => this.createNewFolder(data)
                    });
                    items.push({ divider: true });
                    items.push({
                        label: '„Éï„Ç©„É´„ÉÄ„ÇíÂâäÈô§',
                        action: () => this.deleteMenuItem(data)
                    });
                } else if (data.type === 'root') {
                    // „É´„Éº„Éà„É¨„Éô„É´„ÅÆ„É°„Éã„É•„Éº
                    items.push({
                        label: '„Çπ„Ç≠„É≥„ÇíËøΩÂä†',
                        action: () => this.addSkinToFolder(data.node, data.folderPath, data.currentPckFolder)
                    });
                    items.push({
                        label: '„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê',
                        action: () => this.createNewFolder(data)
                    });
                }
                
                items.forEach(item => {
                    if (item.divider) {
                        const divider = document.createElement('div');
                        divider.className = 'context-menu-divider';
                        menu.appendChild(divider);
                    } else {
                        const menuItem = document.createElement('button');
                        menuItem.className = 'context-menu-item';
                        menuItem.textContent = item.label;
                        menuItem.onclick = (e) => {
                            e.stopPropagation();
                            this.hideContextMenu();
                            item.action();
                        };
                        menu.appendChild(menuItem);
                    }
                });
                
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                
                // „É°„Éã„É•„ÉºÂÜÖ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØ‰ºùÊí≠„Åï„Åõ„Å™„ÅÑ
                menu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // „É°„Éã„É•„Éº‰ª•Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„É°„Éã„É•„Éº„ÅåÊ∂à„Åà„Çã
                const handleClickOutside = (e) => {
                    if (!menu.contains(e.target)) {
                        this.hideContextMenu();
                        document.removeEventListener('click', handleClickOutside);
                    }
                };
                setTimeout(() => document.addEventListener('click', handleClickOutside), 0);
            }

            hideContextMenu() {
                const menu = document.getElementById('contextMenu');
                menu.classList.add('hidden');
            }

            deleteMenuItem(data, parentPckInfo, childIndex, asset) {
                // „Ç¢„Çª„ÉÉ„Éà„ÅåÊ∏°„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØË¶™PCKÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Éï„Ç°„Ç§„É´ÂâäÈô§
                if (asset || (parentPckInfo && childIndex !== undefined)) {
                    // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´ÂâäÈô§
                    const index = typeof data === 'number' ? data : undefined;
                    this.deleteAsset(index, parentPckInfo, childIndex, asset);
                } else if (typeof data === 'number') {
                    // „É´„Éº„Éà„É¨„Éô„É´„ÅÆ„Éï„Ç°„Ç§„É´ÂâäÈô§
                    const index = data;
                    this.deleteAsset(index, parentPckInfo, childIndex, asset);
                } else {
                    // „Éï„Ç©„É´„ÉÄÂâäÈô§
                    this.deleteFolder(data, parentPckInfo);
                }
            }

            deleteFolder(data, parentPckInfo) {
                // Ë¶™PCKÊÉÖÂ†±„ÇíÂèñÂæó
                const actualParentPckInfo = parentPckInfo || data.parentPckInfo || (data.node && data.node._parentPckInfo);
                
                const folderPath = data.folderPath;
                // folderPath„ÅåÊó¢„Å´/„ÅßÁµÇ„Çè„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„Åæ„ÄÅ„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ/„ÇíËøΩÂä†
                const searchPath = folderPath.endsWith('/') ? folderPath : folderPath + '/';
                
                console.log('deleteFolder debug:', {
                    folderPath: folderPath,
                    searchPath: searchPath,
                    currentPckFolder: data.currentPckFolder,
                    hasActualParentPck: !!actualParentPckInfo,
                    nodeHasParentPck: !!(data.node && data.node._parentPckInfo)
                });
                
                // „Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆÂÖ®„Éï„Ç°„Ç§„É´„ÇíÂèéÈõÜ
                let filesToDelete = [];
                
                if (actualParentPckInfo && actualParentPckInfo.asset) {
                    // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄÂâäÈô§
                    const childAssets = this.parsePckAsset(actualParentPckInfo.asset);
                    if (!childAssets) return;
                    
                    console.log(`Nested PCK has ${childAssets.length} assets`);
                    childAssets.forEach((childAsset, idx) => {
                        const matches = childAsset.filename.startsWith(searchPath);
                        console.log(`  [${idx}] ${childAsset.filename} - matches: ${matches}`);
                        if (matches) {
                            filesToDelete.push({
                                asset: childAsset,
                                index: idx,
                                isNested: true
                            });
                        }
                    });
                } else {
                    // „É´„Éº„Éà„É¨„Éô„É´„ÅÆ„Éï„Ç©„É´„ÉÄÂâäÈô§
                    this.assets.forEach((asset, idx) => {
                        if (asset.filename.startsWith(searchPath)) {
                            filesToDelete.push({
                                asset: asset,
                                index: idx,
                                isNested: false
                            });
                        }
                    });
                }
                
                if (filesToDelete.length === 0) {
                    alert('ÂâäÈô§„Åô„Çã„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
                const fileCount = filesToDelete.length;
                if (!confirm(`„Éï„Ç©„É´„ÉÄ "${folderPath}" „Å®„Åù„ÅÆ‰∏≠„ÅÆ ${fileCount} ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                    return;
                }
                
                // „Çπ„Ç≠„É≥„ÅÆDISPLAYNAMEID/THEMENAMEID„ÇíÂèéÈõÜ„Åó„Å¶LOC„Åã„ÇâÂâäÈô§
                const locKeysToRemove = [];
                filesToDelete.forEach(item => {
                    if (item.asset.typeCode === 0 && item.asset.properties) {
                        const displayNameIdProp = item.asset.properties.find(p => p.key === 'DISPLAYNAMEID');
                        const themeNameIdProp = item.asset.properties.find(p => p.key === 'THEMENAMEID');
                        
                        if (displayNameIdProp) {
                            locKeysToRemove.push(displayNameIdProp.value);
                        }
                        if (themeNameIdProp) {
                            locKeysToRemove.push(themeNameIdProp.value);
                        }
                    }
                });
                
                // LOC„Åã„ÇâÂâäÈô§
                locKeysToRemove.forEach(key => {
                    if (actualParentPckInfo && actualParentPckInfo.asset) {
                        // Ë¶™PCKÂÜÖ„ÅÆLOC„Åã„ÇâÂâäÈô§
                        this.removeFromLoc(key, actualParentPckInfo.asset);
                        // Â§ßÂÖÉ„ÅÆLOC„Éï„Ç°„Ç§„É´„Åã„Çâ„ÇÇÂâäÈô§
                        this.removeFromLoc(key);
                    } else {
                        // „É´„Éº„Éà„ÅÆLOC„Åã„ÇâÂâäÈô§
                        this.removeFromLoc(key);
                    }
                });
                
                // „Éï„Ç°„Ç§„É´„ÇíÂâäÈô§Ôºà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂ§ß„Åç„ÅÑÈ†Ü„Å´ÂâäÈô§„Åó„Å¶ÈÖçÂàó„ÅÆ„Åö„Çå„ÇíÈò≤„ÅêÔºâ
                filesToDelete.sort((a, b) => b.index - a.index);
                
                if (actualParentPckInfo && actualParentPckInfo.asset) {
                    // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆÂâäÈô§
                    const pckAsset = actualParentPckInfo.asset;
                    const childAssets = this.parsePckAsset(pckAsset);
                    
                    filesToDelete.forEach(item => {
                        childAssets.splice(item.index, 1);
                    });
                    
                    // PCK„ÇíÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                    const originalPckType = pckAsset.typeCode === 5 ? 3 : (pckAsset.typeCode === 8 ? 4 : 5);
                    const originalLittleEndian = this.parser ? this.parser.littleEndian : false;
                    
                    console.log(`Reencoding PCK after folder deletion: type=${originalPckType}, littleEndian=${originalLittleEndian}, remaining assets=${childAssets.length}`);
                    
                    const updatedPckBuffer = this.encodePck(childAssets, originalPckType, originalLittleEndian);
                    pckAsset.data = new Uint8Array(updatedPckBuffer);
                    pckAsset.dataSize = updatedPckBuffer.byteLength;
                    
                    console.log(`Updated PCK size after folder deletion: ${pckAsset.dataSize} bytes`);
                } else {
                    // „É´„Éº„Éà„É¨„Éô„É´„ÅÆÂâäÈô§
                    filesToDelete.forEach(item => {
                        this.assets.splice(item.index, 1);
                    });
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                
                // UIÊõ¥Êñ∞
                this.displayAssets();
                
                alert(`„Éï„Ç©„É´„ÉÄ "${folderPath}" „Å® ${fileCount} ÂÄã„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
            }

            createNewFolder(data) {
                const folderName = prompt('Êñ∞„Åó„ÅÑ„Éï„Ç©„É´„ÉÄÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
                if (!folderName || folderName.trim() === '') return;
                
                const trimmedName = folderName.trim();
                
                // „Éï„Ç©„É´„ÉÄ„Éë„Çπ„ÇíË®àÁÆó
                let newFolderPath;
                if (data.folderPath && data.folderPath.length > 0) {
                    newFolderPath = data.folderPath + trimmedName;
                } else {
                    newFolderPath = trimmedName;
                }
                
                // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆÂ†¥Âêà„ÄÅPCKÂêç„ÇíÂê´„ÇÅ„Çã
                let actualPath = newFolderPath;
                if (data.currentPckFolder) {
                    actualPath = data.currentPckFolder + '/' + newFolderPath;
                }
                
                // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàêÔºà„Éï„Ç©„É´„ÉÄ„ÅÆÂ≠òÂú®„ÇíË°®ÁèæÔºâ
                const placeholderFilename = actualPath + '/.folder_placeholder';
                const placeholderAsset = {
                    filename: placeholderFilename,
                    typeCode: 99,  // ÁâπÊÆä„Å™„Çø„Ç§„Éó„Ç≥„Éº„Éâ
                    dataSize: 0,
                    dataOffset: 0,
                    properties: [],
                    data: new Uint8Array(0),
                    _isPlaceholder: true  // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Éï„É©„Ç∞
                };
                
                // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆÂ†¥Âêà
                if (data.currentPckFolder) {
                    const pckAsset = this.assets.find(asset => 
                        (asset.typeCode === 5 || asset.typeCode === 8 || asset.typeCode === 11) &&
                        asset.filename === data.currentPckFolder
                    );
                    
                    if (pckAsset) {
                        try {
                            const childAssets = this.parsePckAsset(pckAsset);
                            const pckRelativeFilename = placeholderFilename.substring(data.currentPckFolder.length + 1);
                            const pckPlaceholderAsset = {
                                filename: pckRelativeFilename,
                                typeCode: 99,
                                dataSize: 0,
                                dataOffset: 0,
                                properties: [],
                                data: new Uint8Array(0),
                                _isPlaceholder: true
                            };
                            childAssets.push(pckPlaceholderAsset);
                            
                            // PCK„ÇíÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                            const originalPckType = pckAsset.typeCode === 5 ? 3 : (pckAsset.typeCode === 8 ? 4 : 5);
                            const originalLittleEndian = this.parser ? this.parser.littleEndian : false;
                            const updatedPckBuffer = this.encodePck(childAssets, originalPckType, originalLittleEndian);
                            pckAsset.data = new Uint8Array(updatedPckBuffer);
                            pckAsset.dataSize = updatedPckBuffer.byteLength;
                        } catch (error) {
                            console.error('„Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆ„Éï„Ç©„É´„ÉÄ‰ΩúÊàê„Å´Â§±Êïó:', error);
                            alert('„Éï„Ç©„É´„ÉÄ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                            return;
                        }
                    }
                } else {
                    // „É´„Éº„Éà„É¨„Éô„É´„Å´ËøΩÂä†
                    this.assets.push(placeholderAsset);
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                
                // „ÉÑ„É™„Éº„ÇíÂÜçË°®Á§∫
                this.displayAssets();
                alert(`„Éï„Ç©„É´„ÉÄ "${trimmedName}" „Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºàÂÜÖÈÉ®ÁöÑ„Å´‰ªÆ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„Åæ„ÅôÔºâ`);
            }

            addSkinToFolder(targetNode, folderPath, currentPckFolder = null) {
                this.currentTargetFolderNode = targetNode;
                this.currentTargetFolderPath = folderPath || '';
                this.currentPckFolder = currentPckFolder;
                this.showSkinSelector();
            }

            openSkinAddDialog() {
                // „É´„Éº„Éà„É¨„Éô„É´„Å´„Çπ„Ç≠„É≥„ÇíËøΩÂä†
                this.currentTargetFolderNode = null;
                this.currentTargetFolderPath = '';
                this.currentPckFolder = null;  // PCK „Éï„Ç©„É´„ÉÄ„Çí„É™„Çª„ÉÉ„Éà
                this.showSkinSelector();
            }

            handleSkinFileSelect(file) {
                if (!file) return;
                
                if (!file.name.toLowerCase().endsWith('.png')) {
                    alert('PNGÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedSkinData = e.target.result;
                    
                    // Base64„Ç®„É≥„Ç≥„Éº„Éâ
                    const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(e.target.result)));
                    const dataUrl = 'data:image/png;base64,' + base64;
                    
                    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                    document.getElementById('skinPreview').src = dataUrl;
                    document.getElementById('skinPreviewArea').style.display = 'block';
                };
                reader.readAsArrayBuffer(file);
            }

            handleCapeFileSelect(file) {
                if (!file) {
                    this.selectedCapeData = null;
                    this.selectedCapeName = null;
                    document.getElementById('capePreviewArea').style.display = 'none';
                    return;
                }
                
                if (!file.name.toLowerCase().endsWith('.png')) {
                    alert('PNGÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    document.getElementById('capeFileInput').value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedCapeData = e.target.result;
                    this.selectedCapeName = file.name.replace(/\.png$/i, '');
                    
                    // Base64„Ç®„É≥„Ç≥„Éº„Éâ
                    const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(e.target.result)));
                    const dataUrl = 'data:image/png;base64,' + base64;
                    
                    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                    document.getElementById('capePreview').src = dataUrl;
                    document.getElementById('capePreviewArea').style.display = 'block';
                };
                reader.readAsArrayBuffer(file);
            }

            addSkinToPackage() {
                if (!this.selectedSkinData) {
                    alert('„Çπ„Ç≠„É†„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                // „Çπ„Ç≠„É≥„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà0x7FFF = 32767„Éê„Ç§„ÉàÔºâ
                const MAX_SIZE = 0x7FFF;
                if (this.selectedSkinData.byteLength > MAX_SIZE) {
                    if (!confirm(`‚ö†Ô∏è Ë≠¶Âëä: „Çπ„Ç≠„É≥„ÅÆ„Çµ„Ç§„Ç∫„Åå ${this.selectedSkinData.byteLength} „Éê„Ç§„ÉàÔºà0x${this.selectedSkinData.byteLength.toString(16).toUpperCase()}Ôºâ„Åß„Åô„ÄÇ\n\n0x7FFFÔºà${MAX_SIZE}„Éê„Ç§„ÉàÔºâ„ÇíË∂Ö„Åà„Çã„Çπ„Ç≠„É≥„ÅØ„Ç≤„Éº„É†ÂÜÖ„Åß„ÇØ„É©„ÉÉ„Ç∑„É•„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\n„Åù„Çå„Åß„ÇÇËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }
                }

                // „Éû„É≥„Éà„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.selectedCapeData && this.selectedCapeData.byteLength > MAX_SIZE) {
                    if (!confirm(`‚ö†Ô∏è Ë≠¶Âëä: „Éû„É≥„Éà„ÅÆ„Çµ„Ç§„Ç∫„Åå ${this.selectedCapeData.byteLength} „Éê„Ç§„ÉàÔºà0x${this.selectedCapeData.byteLength.toString(16).toUpperCase()}Ôºâ„Åß„Åô„ÄÇ\n\n0x7FFFÔºà${MAX_SIZE}„Éê„Ç§„ÉàÔºâ„ÇíË∂Ö„Åà„Çã„Éû„É≥„Éà„ÅØ„Ç≤„Éº„É†ÂÜÖ„Åß„ÇØ„É©„ÉÉ„Ç∑„É•„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\n„Åù„Çå„Åß„ÇÇËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }
                }

                const skinName = document.getElementById('skinNameInput').value.trim();
                const skinTheme = document.getElementById('skinThemeInput').value.trim();

                const skinIdInput = document.getElementById('skinIdInput').value.trim();
                if (!skinIdInput) {
                    alert('„Çπ„Ç≠„É≥ID„ÇíÂÖ•Âäõ„Åô„Çã„Åã„ÄÅAuto-Gen„ÅßÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const skinId = parseInt(skinIdInput);
                if (isNaN(skinId) || skinId < 100000 || skinId > 99999998) {
                    alert('„Çπ„Ç≠„É≥ID„ÅØ100000ÔΩû99999998„ÅÆÊï¥Êï∞„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô');
                    return;
                }

                const skinIdPadded = skinId.toString().padStart(8, '0');

                const modelType = document.getElementById('skinModelInput').value;
                const animValue = modelType === 'alex' ? '0x00080000' : '0x00040000';

                // „Éï„Ç©„É´„ÉÄ„Éë„Çπ„Åã„Çâ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÁîüÊàê
                let folderPrefix = '';
                if (this.currentTargetFolderPath && this.currentTargetFolderPath.length > 0) {
                    folderPrefix = this.currentTargetFolderPath
                        .split('/')
                        .filter(p => p && p.trim() !== '')
                        .map(p => p.replace(/\.[^.]+$/, '').toUpperCase())
                        .join('_') + '_';
                }

                // „Çπ„Ç≠„É≥„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„É™„Çπ„Éà
                const skinProperties = [
                    { key: 'DISPLAYNAME', value: skinName },
                    { key: 'DISPLAYNAMEID', value: `IDS_${folderPrefix}dlcskin${skinIdPadded}_DISPLAYNAME` }
                ];

                // THEMENAMEÔºà‰ªªÊÑèÔºâ
                if (skinTheme) {
                    skinProperties.push({ key: 'THEMENAME', value: skinTheme });
                    skinProperties.push({ key: 'THEMENAMEID', value: `IDS_${folderPrefix}dlcskin${skinIdPadded}_THEMENAME` });
                }

                // ÂøÖÈ†à„Éó„É≠„Éë„ÉÜ„Ç£
                skinProperties.push(
                    { key: 'ANIM', value: animValue },
                    { key: 'GAME_FLAGS', value: '0x18' },
                    { key: 'FREE', value: '1' }
                );

                // „Éû„É≥„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
                const capeName = `dlccape${skinIdPadded}`;
                let fullCapeName;
                if (this.currentTargetFolderPath && this.currentTargetFolderPath.length > 0) {
                    let folderPath = this.currentTargetFolderPath.slice(0, -1);  // trailing slash„ÇíÈô§Âéª
                    
                    // PCKÂÜÖ„ÅÆÂ†¥Âêà„ÄÅPCKÂêç + Áõ∏ÂØæ„Éë„Çπ„Å´„Åô„Çã
                    if (this.currentPckFolder) {
                        fullCapeName = this.currentPckFolder + '/' + folderPath + '/' + capeName + '.png';
                    } else {
                        fullCapeName = folderPath + '/' + capeName + '.png';
                    }
                } else {
                    fullCapeName = capeName + '.png';
                }
                
                if (this.selectedCapeData) {
                    skinProperties.push({ key: 'CAPEPATH', value: fullCapeName });
                    const capeAsset = this.assets.find(asset => asset.filename.toLowerCase() === fullCapeName.toLowerCase());
                    if (!capeAsset) {
                        const newCapeAsset = {
                            filename: fullCapeName,
                            typeCode: 1,
                            dataSize: this.selectedCapeData.byteLength,
                            dataOffset: 0,
                            properties: [],
                            data: new Uint8Array(this.selectedCapeData)
                        };
                        this.assets.push(newCapeAsset);
                    }
                }

                // Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É≥„Ç¢„Çª„ÉÉ„Éà„Çí‰ΩúÊàê
                const skinFilename = `dlcskin${skinIdPadded}.png`;
                let fullSkinFilename;
                if (this.currentTargetFolderPath && this.currentTargetFolderPath.length > 0) {
                    let folderPath = this.currentTargetFolderPath.slice(0, -1);  // trailing slash„ÇíÈô§Âéª
                    
                    // PCKÂÜÖ„ÅÆÂ†¥Âêà„ÄÅPCKÂêç + Áõ∏ÂØæ„Éë„Çπ„Å´„Åô„Çã
                    if (this.currentPckFolder) {
                        fullSkinFilename = this.currentPckFolder + '/' + folderPath + '/' + skinFilename;
                    } else {
                        fullSkinFilename = folderPath + '/' + skinFilename;
                    }
                } else {
                    fullSkinFilename = skinFilename;
                }
                
                const newAsset = {
                    filename: fullSkinFilename,
                    typeCode: 0,
                    dataSize: this.selectedSkinData.byteLength,
                    dataOffset: 0,
                    properties: skinProperties,
                    data: new Uint8Array(this.selectedSkinData)
                };

                // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„Å´ËøΩÂä†„Åô„ÇãÂ†¥Âêà
                if (this.currentPckFolder) {
                    const pckAsset = this.assets.find(asset => 
                        (asset.typeCode === 5 || asset.typeCode === 8 || asset.typeCode === 11) &&
                        asset.filename === this.currentPckFolder
                    );
                    
                    if (pckAsset) {
                        try {
                            // PCKÂÜÖÈÉ®„ÇíËß£ÊûêÔºà„É°„Çø„Éá„Éº„Çø„ÇÇÂèñÂæóÔºâ
                            const pckData = pckAsset.data.buffer.slice(pckAsset.data.byteOffset, pckAsset.data.byteOffset + pckAsset.data.byteLength);
                            const pckParser = new PckParser(pckData);
                            const childAssets = pckParser.parse();
                            
                            // PCK„ÅÆ„É°„Çø„Éá„Éº„Çø„Çí‰øùÂ≠ò
                            const originalPckType = pckParser.pckType;
                            const originalLittleEndian = pckParser.isLittleEndian;
                            
                            console.log('Original PCK metadata:', {pckType: originalPckType, littleEndian: originalLittleEndian});
                            
                            // „Çπ„Ç≠„É≥„ÇíPCKÁõ∏ÂØæ„Éë„Çπ„Å´Â§âÊèõ (Skins.pck/Skins/dlcskin.png ‚Üí Skins/dlcskin.png)
                            const pckRelativeFilename = fullSkinFilename.substring(this.currentPckFolder.length + 1);
                            const pckSkinAsset = {
                                filename: pckRelativeFilename,
                                typeCode: 0,
                                dataSize: this.selectedSkinData.byteLength,
                                dataOffset: 0,
                                properties: skinProperties,
                                data: new Uint8Array(this.selectedSkinData)
                            };
                            
                            childAssets.push(pckSkinAsset);
                            
                            // „Éû„É≥„Éà„ÇÇËøΩÂä†
                            if (this.selectedCapeData) {
                                const pckRelativeCapeName = fullCapeName.substring(this.currentPckFolder.length + 1);
                                const pckCapeAsset = {
                                    filename: pckRelativeCapeName,
                                    typeCode: 1,
                                    dataSize: this.selectedCapeData.byteLength,
                                    dataOffset: 0,
                                    properties: [],
                                    data: new Uint8Array(this.selectedCapeData)
                                };
                                childAssets.push(pckCapeAsset);
                            }
                            
                            // PCK„ÇíÂÖÉ„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                            const updatedPckBuffer = this.encodePck(childAssets, originalPckType, originalLittleEndian);
                            pckAsset.data = new Uint8Array(updatedPckBuffer);
                            pckAsset.dataSize = updatedPckBuffer.byteLength;
                            
                            this.selectedAsset = pckSkinAsset;
                        } catch (error) {
                            console.error('„Éç„Çπ„Éà„Åï„Çå„ÅüPCK„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó:', error);
                            alert('„Éç„Çπ„Éà„Åï„Çå„ÅüPCK„Å∏„ÅÆ„Çπ„Ç≠„É≥ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                            return;
                        }
                    } else {
                        alert('PCK„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                        return;
                    }
                } else {
                    // „É°„Ç§„É≥„É¨„Éô„É´„Å´ËøΩÂä†
                    this.assets.push(newAsset);
                    
                    if (this.selectedCapeData) {
                        const capeAsset = this.assets.find(asset => asset.filename.toLowerCase() === fullCapeName.toLowerCase());
                        if (!capeAsset) {
                            const newCapeAsset = {
                                filename: fullCapeName,
                                typeCode: 1,
                                dataSize: this.selectedCapeData.byteLength,
                                dataOffset: 0,
                                properties: [],
                                data: new Uint8Array(this.selectedCapeData)
                            };
                            this.assets.push(newCapeAsset);
                        }
                    }
                    
                    this.selectedAsset = newAsset;
                }

                // .loc„Éï„Ç°„Ç§„É´„Å´„Çπ„Ç≠„É≥ÊÉÖÂ†±„ÇíÊõ∏„ÅçËæº„ÇÄ
                this.addSkinNameToLoc(skinName, skinTheme, skinIdPadded, this.currentTargetFolderPath);

                // UIÊõ¥Êñ∞
                this.displayAssets();
                this.selectAsset(newAsset, document.querySelector('.asset-item:last-child'), this.assets.length - 1);
                
                this.closeImportModal();
                
                let message = `„Çπ„Ç≠„É≥ID: ${skinIdPadded} (${modelType}„É¢„Éá„É´)„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`;
                if (skinName) {
                    message = `„Çπ„Ç≠„É≥„Äå${skinName}„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü\n` + message;
                }
                if (skinTheme) {
                    message += `\n„ÉÜ„Éº„Éû: ${skinTheme}`;
                }
                message += `\n.loc„Éï„Ç°„Ç§„É´„Å´ÊÉÖÂ†±„ÇíË®òÈå≤„Åó„Åæ„Åó„Åü`;
                if (this.selectedCapeData) {
                    message += `\n„Éû„É≥„Éà„Äå${fullCapeName}„Äç„ÇÇËøΩÂä†„Åó„Åæ„Åó„Åü`;
                }
                alert(message);
            }

            addSkinNameToLoc(skinName, skinTheme, skinIdPadded, folderPath = '') {
                const locAsset = this.assets.find(asset => asset.filename.toLowerCase().endsWith('.loc'));
                if (!locAsset) {
                    return;
                }

                try {
                    const locParser = new LOCParser(locAsset.data.buffer.slice(locAsset.data.byteOffset, locAsset.data.byteOffset + locAsset.data.byteLength));
                    const parseResult = locParser.parse();
                    
                    if (!parseResult) {
                        return;
                    }

                    // „Éï„Ç©„É´„ÉÄ„Éë„Çπ„Åã„Çâ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÁîüÊàê
                    let folderPrefix = '';
                    if (folderPath && folderPath.length > 0) {
                        // "Skins/" ‚Üí "SKINS_", "Textures/Skins/" ‚Üí "TEXTURES_SKINS_"
                        folderPrefix = folderPath
                            .split('/')
                            .filter(p => p && p.trim() !== '')
                            .map(p => p.replace(/\.[^.]+$/, '').toUpperCase())
                            .join('_') + '_';
                    }

                    const skinLocKey = `IDS_${folderPrefix}dlcskin${skinIdPadded}_DISPLAYNAME`;
                    parseResult.languages.forEach(language => {
                        if (!parseResult.locData[language]) {
                            parseResult.locData[language] = {};
                        }
                        parseResult.locData[language][skinLocKey] = skinName;
                    });

                    if (skinTheme) {
                        const themeLocKey = `IDS_${folderPrefix}dlcskin${skinIdPadded}_THEMENAME`;
                        parseResult.languages.forEach(language => {
                            if (!parseResult.locData[language]) {
                                parseResult.locData[language] = {};
                            }
                            parseResult.locData[language][themeLocKey] = skinTheme;
                        });
                    }

                    if (!parseResult.keys.includes(skinLocKey)) {
                        parseResult.keys.push(skinLocKey);
                    }
                    if (skinTheme) {
                        const themeLocKey = `IDS_${folderPrefix}dlcskin${skinIdPadded}_THEMENAME`;
                        if (!parseResult.keys.includes(themeLocKey)) {
                            parseResult.keys.push(themeLocKey);
                        }
                    }

                    const updatedLocBuffer = this.buildLocBuffer(parseResult);
                    locAsset.data = new Uint8Array(updatedLocBuffer);
                    locAsset.dataSize = updatedLocBuffer.byteLength;
                } catch (error) {
                    // LogError silently
                }
            }


            buildLocBuffer(locFileData) {
                try {
                    const { 
                        languages, 
                        locData, 
                        keys, 
                        versions = {}, 
                        hasUidsInEntry = {}, 
                        hasUids = false, 
                        loc_type = 2 
                    } = locFileData;
                    
                    const encoder = new TextEncoder();
                    const chunks = [];
                    let totalOffset = 0;

                    // Header
                    {
                        const buf = new ArrayBuffer(8);
                        const view = new DataView(buf);
                        view.setUint32(0, 2, false);
                        view.setUint32(4, languages.length, false);
                        chunks.push(new Uint8Array(buf));
                        totalOffset += 8;
                    }

                    // Keys
                    {
                        const useUniqueIds = keys.length > 0 && keys[0].match(/^[0-9A-F]{8}$/);
                        
                        const keyBuf = new ArrayBuffer(1 + 4);
                        const keyView = new DataView(keyBuf);
                        keyView.setUint8(0, useUniqueIds ? 1 : 0);
                        keyView.setUint32(1, keys.length, false);
                        chunks.push(new Uint8Array(keyBuf));
                        totalOffset += 5;

                        keys.forEach((key, idx) => {
                            if (useUniqueIds && key.match(/^[0-9A-F]{8}$/)) {
                                const buf = new ArrayBuffer(4);
                                new DataView(buf).setUint32(0, parseInt(key, 16), false);
                                chunks.push(new Uint8Array(buf));
                                totalOffset += 4;
                            } else {
                                const keyBytes = encoder.encode(key);
                                const buf = new ArrayBuffer(2 + keyBytes.length);
                                new DataView(buf).setUint16(0, keyBytes.length, false);
                                new Uint8Array(buf, 2).set(keyBytes);
                                chunks.push(new Uint8Array(buf));
                                totalOffset += 2 + keyBytes.length;
                            }
                        });
                    }

                    // Languages and entries
                    const entryBufs = [];
                    languages.forEach((lang, langIdx) => {
                        // Language name
                        const langBytes = encoder.encode(lang);
                        const langBuf = new ArrayBuffer(2 + langBytes.length);
                        new DataView(langBuf).setUint16(0, langBytes.length, false);
                        new Uint8Array(langBuf, 2).set(langBytes);
                        chunks.push(new Uint8Array(langBuf));
                        totalOffset += 2 + langBytes.length;

                        // Build entry
                        const useUniqueIds = keys.length > 0 && keys[0].match(/^[0-9A-F]{8}$/);
                        const entryChunks = [];

                        // version
                        {
                            const version = (versions && versions[lang]) || loc_type || 2;
                            const buf = new ArrayBuffer(4);
                            new DataView(buf).setUint32(0, version, false);
                            entryChunks.push(new Uint8Array(buf));

                            if (version > 0) {
                                const hasUidsValue = hasUidsInEntry?.[lang] ?? hasUids ?? (useUniqueIds ? 1 : 0);
                                entryChunks.push(new Uint8Array([hasUidsValue ? 1 : 0]));
                            }
                        }

                        // Language name (repeat)
                        {
                            const buf = new ArrayBuffer(2 + langBytes.length);
                            new DataView(buf).setUint16(0, langBytes.length, false);
                            new Uint8Array(buf, 2).set(langBytes);
                            entryChunks.push(new Uint8Array(buf));
                        }

                        // Count
                        {
                            const buf = new ArrayBuffer(4);
                            new DataView(buf).setUint32(0, keys.length, false);
                            entryChunks.push(new Uint8Array(buf));
                        }

                        // Values
                        keys.forEach((key, idx) => {
                            const value = (locData[lang] && locData[lang][key]) || '';
                            const valueBytes = encoder.encode(value);
                            const buf = new ArrayBuffer(2 + valueBytes.length);
                            new DataView(buf).setUint16(0, valueBytes.length, false);
                            new Uint8Array(buf, 2).set(valueBytes);
                            entryChunks.push(new Uint8Array(buf));
                        });

                        // Assemble entry
                        let entrySize = 0;
                        entryChunks.forEach(c => entrySize += c.length);
                        const entryBuf = new ArrayBuffer(entrySize);
                        let pos = 0;
                        entryChunks.forEach(c => {
                            new Uint8Array(entryBuf, pos).set(c);
                            pos += c.length;
                        });
                        entryBufs.push(new Uint8Array(entryBuf));

                        // Buffer size
                        {
                            const buf = new ArrayBuffer(4);
                            new DataView(buf).setUint32(0, entrySize, false);
                            chunks.push(new Uint8Array(buf));
                            totalOffset += 4 + entrySize;
                        }
                    });

                    // Add entries
                    entryBufs.forEach(buf => chunks.push(buf));

                    // Combine
                    let totalSize = 0;
                    chunks.forEach(c => totalSize += c.length);
                    
                    const result = new ArrayBuffer(totalSize);
                    let offset = 0;
                    chunks.forEach(c => {
                        new Uint8Array(result, offset).set(c);
                        offset += c.length;
                    });
                    
                    return result;
                } catch (error) {
                    console.error('buildLocBuffer error:', error);
                    throw error;
                }
            }

            closeImportModal() {
                const modal = document.getElementById('importModal');
                modal.classList.remove('active');
                this.selectedSkinData = null;
                this.selectedCapeData = null;
                this.selectedCapeName = null;
            }

            generateSkinId() {
                // Êó¢Â≠ò„Çπ„Ç≠„É≥„ÅÆID„ÇíÊäΩÂá∫
                const existingIds = new Set();
                this.assets.forEach(asset => {
                    const filename = asset.filename.toLowerCase();
                    if (filename.startsWith('dlcskin') && filename.endsWith('.png')) {
                        const idStr = filename.substring(7, 15); // "dlcskin"(7ÊñáÂ≠ó)„ÅÆÂæå„ÅÆ8ÊñáÂ≠ó
                        if (/^\d{8}$/.test(idStr)) {
                            existingIds.add(parseInt(idStr));
                        }
                    }
                });

                // ÈáçË§á„Åó„Å™„ÅÑ„É©„É≥„ÉÄ„É†„Å™ID„ÇíÁîüÊàê
                let newId;
                let attempts = 0;
                do {
                    newId = Math.floor(Math.random() * (99999998 - 100000 + 1)) + 100000;
                    attempts++;
                    if (attempts > 1000) {
                        alert('Êñ∞„Åó„ÅÑ„Çπ„Ç≠„É≥ID„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        return;
                    }
                } while (existingIds.has(newId));

                // ID„Çí„Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö
                document.getElementById('skinIdInput').value = newId;
            }

            // ========== „Éó„É≠„Éë„ÉÜ„Ç£Á∑®ÈõÜÊ©üËÉΩ ==========
            updateProperty(input) {
                if (!this.selectedAsset) return;
                
                const index = parseInt(input.dataset.index);
                const type = input.dataset.type;
                const value = input.value.trim();
                
                if (type === 'key') {
                    if (!value) {
                        alert('„Ç≠„Éº„ÅØÁ©∫„Å´„Åß„Åç„Åæ„Åõ„Çì');
                        input.value = this.selectedAsset.properties[index].key;
                        return;
                    }
                    this.selectedAsset.properties[index].key = value;
                } else if (type === 'value') {
                    this.selectedAsset.properties[index].value = value;
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
            }

            deleteAsset(index, parentPckInfo, childIndex, assetToDelete) {
                // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÅÆÂ†¥Âêà
                if (parentPckInfo && childIndex !== undefined && assetToDelete) {
                    const asset = assetToDelete;
                    if (!confirm(`„Ç¢„Çª„ÉÉ„Éà ${this.escapeHtml(asset.filename)} „ÇíÂâäÈô§„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                        return;
                    }
                    
                    // „Çπ„Ç≠„É≥„ÅÆÂ†¥Âêà„ÄÅloc„Éï„Ç°„Ç§„É´„Åã„Çâ„ÇÇÂâäÈô§ÔºàË¶™PCKÂÜÖ„ÅÆLOC„Å®Â§ßÂÖÉ„ÅÆLOC„Åã„ÇâÔºâ
                    if (asset.typeCode === 0 && asset.properties) {
                        const displayNameIdProp = asset.properties.find(p => p.key === 'DISPLAYNAMEID');
                        const themeNameIdProp = asset.properties.find(p => p.key === 'THEMENAMEID');
                        
                        if (displayNameIdProp) {
                            // Ë¶™PCKÂÜÖ„ÅÆLOC„Åã„ÇâÂâäÈô§
                            this.removeFromLoc(displayNameIdProp.value, parentPckInfo.asset);
                            // Â§ßÂÖÉ„ÅÆLOC„Éï„Ç°„Ç§„É´„Åã„Çâ„ÇÇÂâäÈô§
                            this.removeFromLoc(displayNameIdProp.value);
                        }
                        if (themeNameIdProp) {
                            // Ë¶™PCKÂÜÖ„ÅÆLOC„Åã„ÇâÂâäÈô§
                            this.removeFromLoc(themeNameIdProp.value, parentPckInfo.asset);
                            // Â§ßÂÖÉ„ÅÆLOC„Éï„Ç°„Ç§„É´„Åã„Çâ„ÇÇÂâäÈô§
                            this.removeFromLoc(themeNameIdProp.value);
                        }
                    }
                    
                    // Ë¶™PCK„Åã„ÇâÂ≠ê„Ç¢„Çª„ÉÉ„Éà„ÇíÂâäÈô§
                    const pckAsset = parentPckInfo.asset;
                    const childAssets = this.parsePckAsset(pckAsset);
                    
                    if (!childAssets || childIndex >= childAssets.length) {
                        alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºö„Ç¢„Çª„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                        return;
                    }
                    
                    // Â≠ê„Ç¢„Çª„ÉÉ„Éà„ÇíÂâäÈô§
                    childAssets.splice(childIndex, 1);
                    
                    // PCK„ÇíÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                    const originalPckType = pckAsset.typeCode === 5 ? 3 : (pckAsset.typeCode === 8 ? 4 : 5);
                    const originalLittleEndian = this.parser ? this.parser.littleEndian : false;
                    
                    console.log(`Reencoding PCK after deletion: type=${originalPckType}, littleEndian=${originalLittleEndian}, remaining assets=${childAssets.length}`);
                    
                    const updatedPckBuffer = this.encodePck(childAssets, originalPckType, originalLittleEndian);
                    pckAsset.data = new Uint8Array(updatedPckBuffer);
                    pckAsset.dataSize = updatedPckBuffer.byteLength;
                    
                    console.log(`Updated PCK size: ${pckAsset.dataSize} bytes`);
                } else {
                    // „É°„Ç§„É≥„ÅÆassets„Åã„ÇâÂâäÈô§ÔºàÂæìÊù•„ÅÆÂá¶ÁêÜÔºâ
                    const asset = this.assets[index];
                    if (!confirm(`„Ç¢„Çª„ÉÉ„Éà [${index}] ${this.escapeHtml(asset.filename)} „ÇíÂâäÈô§„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                        return;
                    }
                    
                    // „Çπ„Ç≠„É≥„ÅÆÂ†¥Âêà„ÄÅloc„Éï„Ç°„Ç§„É´„Åã„Çâ„ÇÇÂâäÈô§
                    if (asset.typeCode === 0 && asset.properties) {
                        const displayNameIdProp = asset.properties.find(p => p.key === 'DISPLAYNAMEID');
                        const themeNameIdProp = asset.properties.find(p => p.key === 'THEMENAMEID');
                        
                        if (displayNameIdProp) {
                            this.removeFromLoc(displayNameIdProp.value);
                        }
                        if (themeNameIdProp) {
                            this.removeFromLoc(themeNameIdProp.value);
                        }
                    }
                    
                    this.assets.splice(index, 1);
                }
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                
                // UIÊõ¥Êñ∞
                this.displayAssets();
                
                // Ë©≥Á¥∞„Çí„ÇØ„É™„Ç¢
                const container = document.getElementById('detailsContent');
                container.innerHTML = '<div class="empty-message"><div class="empty-icon">‚ÑπÔ∏è</div>„Ç¢„Çª„ÉÉ„ÉàÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>';
            }
            
            removeFromLoc(keyToRemove, parentPckAsset = null) {
                let locAsset;
                
                // Ë¶™PCK„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„ÅÆ‰∏≠„ÅÆLOC„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô
                if (parentPckAsset) {
                    const childAssets = this.parsePckAsset(parentPckAsset);
                    if (childAssets) {
                        locAsset = childAssets.find(asset => asset.filename.toLowerCase().endsWith('.loc'));
                    }
                } else {
                    // „É°„Ç§„É≥„ÅÆassets„Åã„ÇâLOC„ÇíÊé¢„Åô
                    locAsset = this.assets.find(asset => asset.filename.toLowerCase().endsWith('.loc'));
                }
                
                if (!locAsset) {
                    return;
                }

                try {
                    const locParser = new LOCParser(locAsset.data.buffer.slice(locAsset.data.byteOffset, locAsset.data.byteOffset + locAsset.data.byteLength));
                    const parseResult = locParser.parse();
                    
                    if (!parseResult) {
                        return;
                    }

                    // „Ç≠„Éº„ÇíÂâäÈô§
                    const keyIndex = parseResult.keys.indexOf(keyToRemove);
                    if (keyIndex !== -1) {
                        parseResult.keys.splice(keyIndex, 1);
                        
                        // ÂêÑË®ÄË™û„Åã„Çâ„ÇÇÂâäÈô§
                        parseResult.languages.forEach(language => {
                            if (parseResult.locData[language] && parseResult.locData[language][keyToRemove]) {
                                delete parseResult.locData[language][keyToRemove];
                            }
                        });
                        
                        // Êõ¥Êñ∞„Åï„Çå„Åüloc„Éï„Ç°„Ç§„É´„ÇíÂÜçÊßãÁØâ
                        const updatedLocBuffer = this.buildLocBuffer(parseResult);
                        locAsset.data = new Uint8Array(updatedLocBuffer);
                        locAsset.dataSize = updatedLocBuffer.byteLength;
                    }
                } catch (error) {
                    console.error('loc„Éï„Ç°„Ç§„É´„Åã„Çâ„ÅÆ„Ç≠„ÉºÂâäÈô§„Å´Â§±Êïó:', error);
                }
            }

            deleteProperty(index) {
                if (!this.selectedAsset) return;
                
                const key = this.selectedAsset.properties[index].key;
                if (!confirm(`„Éó„É≠„Éë„ÉÜ„Ç£„Äå${key}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                    return;
                }
                
                this.selectedAsset.properties.splice(index, 1);
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                
                // Ë©≥Á¥∞„ÇíÂÜçÊèèÁîª
                this.displayDetails(this.selectedAsset);
            }

            addProperty() {
                if (!this.selectedAsset) return;
                
                if (!this.selectedAsset.properties) {
                    this.selectedAsset.properties = [];
                }
                
                // Êñ∞„Åó„ÅÑ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíËøΩÂä†
                this.selectedAsset.properties.push({
                    key: 'KEY',
                    value: 'VALUE'
                });
                
                // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('menuSave').style.opacity = '1';
                document.getElementById('menuSave').style.pointerEvents = 'auto';
                
                // Ë©≥Á¥∞„ÇíÂÜçÊèèÁîª
                this.displayDetails(this.selectedAsset);
            }

            // ========== ÁîªÂÉèÁΩÆ„ÅçÊèõ„ÅàÊ©üËÉΩ ==========
            replaceAssetImage(asset, parentPckInfo, childIndex) {
                if (!asset) {
                    alert('„Ç¢„Çª„ÉÉ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    return;
                }
                
                const input = document.getElementById('pngReplaceInput');
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const newData = new Uint8Array(evt.target.result);
                            asset.data = newData;
                            asset.dataSize = newData.length;
                            
                            // „Éç„Çπ„Éà„Åï„Çå„ÅüPCKÂÜÖ„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÄÅË¶™PCK„ÇíÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                            if (parentPckInfo && childIndex !== undefined) {
                                const pckAsset = parentPckInfo.asset;
                                const childAssets = this.parsePckAsset(pckAsset);
                                
                                if (childAssets && childIndex < childAssets.length) {
                                    // Â≠ê„Ç¢„Çª„ÉÉ„Éà„ÇíÊõ¥Êñ∞
                                    childAssets[childIndex] = asset;
                                    
                                    // PCK„ÇíÂÜç„Ç®„É≥„Ç≥„Éº„Éâ
                                    const originalPckType = pckAsset.typeCode === 5 ? 3 : (pckAsset.typeCode === 8 ? 4 : 5);
                                    const originalLittleEndian = this.parser ? this.parser.littleEndian : false;
                                    
                                    const updatedPckBuffer = this.encodePck(childAssets, originalPckType, originalLittleEndian);
                                    pckAsset.data = new Uint8Array(updatedPckBuffer);
                                    pckAsset.dataSize = updatedPckBuffer.byteLength;
                                }
                            }
                            
                            // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„Çª„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÄÅ„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
                            if (this.selectedAsset === asset) {
                                this.displayImage(asset);
                            }
                            
                            alert(`${asset.filename} „ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü`);
                            
                            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                            document.getElementById('menuSave').style.opacity = '1';
                            document.getElementById('menuSave').style.pointerEvents = 'auto';
                            
                            // UIÊõ¥Êñ∞
                            this.displayAssets();
                        };
                        reader.readAsArrayBuffer(file);
                    }
                    input.value = '';
                };
                input.click();
            }

            // ÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´‰øùÊåÅ
            replacePng() {
                if (!this.selectedAsset) {
                    alert('„Ç¢„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                this.replaceAssetImage(this.selectedAsset, null, null);
            }

            // ========== LOCÁ∑®ÈõÜÊ©üËÉΩ ==========
            updateLocValue(input) {
                if (!this.currentLocData || !this.selectedAsset) return;
                
                const key = input.dataset.key;
                const lang = input.dataset.lang;
                const value = input.value;
                
                if (!this.currentLocData.locData[lang]) {
                    this.currentLocData.locData[lang] = {};
                }
                
                this.currentLocData.locData[lang][key] = value;
                
                // LOC„Éê„ÉÉ„Éï„Ç°„ÇíÂÜçÊßãÁØâ
                this.rebuildLocBuffer();
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ëµ∑Âãï
        let viewer;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing viewer...');
            viewer = new PckViewer();
            window.viewer = viewer; // „Ç∞„É≠„Éº„Éê„É´„Å´ÊòéÁ§∫ÁöÑ„Å´ÂÖ¨Èñã
            console.log('Viewer initialized');

            // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('skinModal').addEventListener('click', (e) => {
                if (e.target.id === 'skinModal') {
                    viewer.closeSkinModal();
                }
            });
            
            // ‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('saveDialogOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'saveDialogOverlay') {
                    viewer.closeSaveDialog();
                }
            });
        });
    </script>
</body>
</html>
